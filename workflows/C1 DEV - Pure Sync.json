{
  "name": "C1 DEV - Pure Sync",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "49c81197-2e94-492f-a28d-cec975955815-dev",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1216,
        2912
      ],
      "id": "74513498-36de-4781-94b0-2799ad0256fd",
      "name": "Webhook2",
      "webhookId": "49c81197-2e94-492f-a28d-cec975955815"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "yixtx4eC9r1PFAYb",
          "mode": "list",
          "cachedResultName": "AireminderTest_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/yixtx4eC9r1PFAYb"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $json.body.phone }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_id": "={{ $json.body.user_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "sent_at",
              "displayName": "sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -1008,
        2912
      ],
      "id": "189f4c56-141d-4d70-ba6c-2e2be8a81ec2",
      "name": "Update row(s)2"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -1232,
        3088
      ],
      "id": "ec3d7a74-23eb-4291-9c94-441c8641abd1",
      "name": "Every Hour Trigger2"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "reminder_sent",
              "condition": "isFalse"
            },
            {
              "keyName": "reminder_sent",
              "condition": "isEmpty"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -960,
        3088
      ],
      "id": "e8526de4-27be-45cd-8143-1805a2265ed7",
      "name": "Get Unsent Reminders2"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º —Ç–∞–π–º–∑–æ–Ω—É (–∑–¥–µ—Å—å —Å–ª–æ–∂–Ω–µ–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–∞—Å—Å–∏–≤ —Ä–∞–∑–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤)\n// –í –∏–¥–µ–∞–ª–µ, –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å Merge —Å —Ç–∞–±–ª–∏—Ü–µ–π –º–∞—Å—Ç–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ —ç—Ç–∏–º —à–∞–≥–æ–º.\n// –ù–æ –µ—Å–ª–∏ –ø–æ–∫–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–æ, —Ç–æ —Å—á–∏—Ç–∞–µ–º –ø–æ –ú–æ—Å–∫–≤–µ, –∏–ª–∏ –±–µ—Ä–µ–º —Ç–∞–π–º–∑–æ–Ω—É –∏–∑ –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—à—å –µ—ë –≤ appointment_reminders).\n\n// –ï—Å–ª–∏ —Ç–∞–π–º–∑–æ–Ω—ã –≤ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ú–æ—Å–∫–≤—É –∫–∞–∫ –¥–µ—Ñ–æ–ª—Ç\nconst defaultZone = 'Europe/Moscow';\n\nreturn items.filter(item => {\n  // –ï—Å–ª–∏ –≤ –∑–∞–ø–∏—Å–∏ –µ—Å—Ç—å —Ç–∞–π–º–∑–æ–Ω–∞ –º–∞—Å—Ç–µ—Ä–∞ (–Ω–∞–¥–æ –±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏!)\n  const tz = item.json.master_timezone || defaultZone;\n  \n  const apptTime = DateTime.fromISO(item.json.appointment_time).setZone(tz);\n  const now = DateTime.now().setZone(tz);\n  \n  // –†–∞–∑–Ω–∏—Ü–∞ –≤ —á–∞—Å–∞—Ö\n  const diffHours = apptTime.diff(now, 'hours').hours;\n\n  // –ë–µ—Ä–µ–º –≤—Å—ë, —á—Ç–æ –±—É–¥–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–µ 25 —á–∞—Å–æ–≤\n  return diffHours > 0 && diffHours <= 25;\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        2960
      ],
      "id": "35dd345c-a9d8-4bd5-9a8c-2cb8db6faea7",
      "name": "Filter 24h Before2"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "yixtx4eC9r1PFAYb",
          "mode": "list",
          "cachedResultName": "AireminderTest_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/yixtx4eC9r1PFAYb"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $json.client_phone }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -592,
        3168
      ],
      "id": "0fd2e6a5-9736-4bea-9bea-466becadbe7a",
      "name": "Find Client Telegram2",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "event_id",
              "keyValue": "={{ $('Merge2').item.json.event_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "reminder_sent": true
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "reminder_sent",
              "displayName": "reminder_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        768,
        3088
      ],
      "id": "8a7aa5b4-1fa3-41e9-99e2-a91bb60f8c2c",
      "name": "Mark as Sent2"
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ $json.client_name }}! üå∏\n\n–ñ–¥–µ–º –í–∞—Å –∑–∞–≤—Ç—Ä–∞, {{ $json.appointment_time.toDateTime().setZone('Europe/Moscow').setLocale('ru').toFormat('d MMMM') }} –≤ {{ $json.appointment_time.toDateTime().setZone('Europe/Moscow').toFormat('HH:mm') }} –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É: {{ $json.service_type }}.\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∏–∑–∏—Ç –Ω–∞–∂–∞—Ç–∏–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ. üëá",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "‚úÖ –ë—É–¥—É",
                    "additionalFields": {
                      "callback_data": "=confirm_booking_{{ $json.event_id }}"
                    }
                  },
                  {
                    "text": "‚ùå –û—Ç–º–µ–Ω–∞",
                    "additionalFields": {
                      "callback_data": "=cancel_booking_{{ $json.event_id }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        528,
        3088
      ],
      "id": "939d8651-23ad-4282-b03e-3981631908a8",
      "name": "Send a text message2",
      "webhookId": "248ce7a8-58b6-4407-a8ba-ed9963996662",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "a6ffddcb-5839-457d-aa0c-11f5ac4bcad1",
              "leftValue": "={{ $json.telegram_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        144,
        3072
      ],
      "id": "19d012e6-5935-4a20-af7a-007ceddd85f7",
      "name": "Filter2"
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "client_phone",
              "field2": "phone"
            }
          ]
        },
        "joinMode": "enrichInput1",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -48,
        3072
      ],
      "id": "3ef7973d-8207-4522-8c4b-7cd0007c2def",
      "name": "Merge2"
    },
    {
      "parameters": {
        "compare": "selectedFields",
        "fieldsToCompare": "phone",
        "options": {}
      },
      "type": "n8n-nodes-base.removeDuplicates",
      "typeVersion": 2,
      "position": [
        -384,
        3168
      ],
      "id": "d3e4d903-27ef-4937-ad3f-47930d4176f7",
      "name": "Remove Duplicates2"
    },
    {
      "parameters": {
        "path": "oauth-callback-dev",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1296,
        1456
      ],
      "id": "22c38979-0321-4566-a7b7-dcc65e9219ae",
      "name": "Webhook1",
      "webhookId": "842a26ef-515e-46f1-8e5a-113c1ff0ce7c"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://oauth2.googleapis.com/token",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "code",
              "value": "={{ $('Webhook1').item.json.query.code }}"
            },
            {
              "name": "redirect_uri",
              "value": "={{ $env.GOOGLE_REDIRECT_URI }}-dev"
            },
            {
              "name": "grant_type",
              "value": "authorization_code"
            },
            {
              "name": "client_id",
              "value": "={{ $env.GOOGLE_CLIENT_ID }}"
            },
            {
              "name": "client_secret",
              "value": "={{ $env.GOOGLE_CLIENT_SECRET }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1136,
        1456
      ],
      "id": "1b29eddc-d9e0-4b31-85bd-4646b7867568",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <title>–£—Å–ø–µ—à–Ω–æ!</title>\n  <style>\n    body {\n      font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      height: 100vh;\n      margin: 0;\n      background-color: #f0f2f5;\n      color: #333;\n    }\n    .card {\n      background: white;\n      padding: 40px;\n      border-radius: 16px;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n      text-align: center;\n      max-width: 90%;\n      width: 300px;\n    }\n    .icon {\n      font-size: 48px;\n      margin-bottom: 20px;\n    }\n    h1 {\n      font-size: 24px;\n      margin: 0 0 10px 0;\n    }\n    p {\n      color: #666;\n      margin-bottom: 30px;\n    }\n    .btn {\n      display: inline-block;\n      background-color: #0088cc;\n      color: white;\n      text-decoration: none;\n      padding: 12px 24px;\n      border-radius: 8px;\n      font-weight: bold;\n      transition: background 0.2s;\n    }\n    .btn:hover {\n      background-color: #0077b5;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"card\">\n    <div class=\"icon\">‚úÖ</div>\n    <h1>–ì–æ—Ç–æ–≤–æ!</h1>\n    <p>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω.</p>\n    <a href=\"tg://resolve?domain=pmn8nbot_bot\" class=\"btn\">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ Telegram</a>\n  </div>\n</body>\n</html>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        160,
        1440
      ],
      "id": "e0a1e8bf-6b28-471e-95aa-88b89a67f8c3",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/oauth2/v3/userinfo",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('HTTP Request2').item.json.access_token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -784,
        1456
      ],
      "id": "e412b4b4-96ee-4ef3-9a86-2408fcb4c71a",
      "name": "HTTP Request3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "78a0b2be-65bd-41e5-92fa-a89da10a0460",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -448,
        1456
      ],
      "id": "8ef5515e-fc39-4b14-a320-b0db25529f89",
      "name": "If4"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "is_active": false
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_google_email",
              "displayName": "master_google_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_name",
              "displayName": "master_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "display_name",
              "displayName": "display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name_dat",
              "displayName": "display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "onboarding_state",
              "displayName": "onboarding_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "slot_duration",
              "displayName": "slot_duration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -336,
        1616
      ],
      "id": "b16c8470-366d-48ff-8fc1-7a9758652577",
      "name": "Insert row1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Webhook1').item.json.query.state }}",
        "text": "üîó –ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!  –û—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —à—Ç—Ä–∏—Ö. –ù–∞–ø–∏—à–∏ –≤ –æ—Ç–≤–µ—Ç, –∫–∞–∫ –º–Ω–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∫–ª–∏–µ–Ω—Ç–∞–º? –ü—Ä–∏–º–µ—Ä—ã: –ú–∞—Å—Ç–µ—Ä –ú–∞—Ä–∏—è / –°—Ç—É–¥–∏—è Glow / Beauty-Bar",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        112,
        1616
      ],
      "id": "a538c9d7-7c1d-4ec1-ae0f-3b42abbc71e9",
      "name": "Send a text message",
      "webhookId": "a7231f0f-add0-481a-8e8c-b2bf75e88723",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{$json.message.from.id}}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "is_active": false,
            "onboarding_state": "wait_display_name"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_google_email",
              "displayName": "master_google_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_name",
              "displayName": "master_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "display_name",
              "displayName": "display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "display_name_dat",
              "displayName": "display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "onboarding_state",
              "displayName": "onboarding_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -128,
        1616
      ],
      "id": "1f9828e1-bd91-4c1d-a824-394a34afc4fb",
      "name": "Set Onboarding State1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ddf99324-7780-431f-b569-a31545bbca26",
              "leftValue": "={{ $('Get row(s)').item.json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -816,
        -192
      ],
      "id": "c1b219eb-8d68-4bf7-80c5-d825deebcca0",
      "name": "If1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "–ü—Ä–∏–≤–µ—Ç! üëã –Ø ‚Äî Remi, —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.  –Ø –≤–æ–∑—å–º—É –Ω–∞ —Å–µ–±—è —Ä—É—Ç–∏–Ω—É: –Ω–∞–ø–æ–º–Ω—é –∫–ª–∏–µ–Ω—Ç–∞–º –æ –∑–∞–ø–∏—Å–∏, –ø–æ–¥—Ç–≤–µ—Ä–∂—É –≤–∏–∑–∏—Ç –∏ —Å–æ–±–µ—Ä—É –æ—Ç–∑—ã–≤—ã, —á—Ç–æ–±—ã —Ç—ã –Ω–µ –æ—Ç–≤–ª–µ–∫–∞–ª—Å—è(–∞—Å—å) –æ—Ç —Ä–∞–±–æ—Ç—ã.  –ß—Ç–æ–±—ã —è —É–≤–∏–¥–µ–ª —Ç–≤–æ—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –º–Ω–µ –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Google –ö–∞–ª–µ–Ω–¥–∞—Ä—é. –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ ‚Äî —è —Ä–∞–±–æ—Ç–∞—é —Ç–æ–ª—å–∫–æ —Å —Ç–≤–æ–∏–º–∏ —Ä–∞–±–æ—á–∏–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏.  üëá –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å Google Calendar",
                    "additionalFields": {
                      "url": "=https://accounts.google.com/o/oauth2/v2/auth?client_id={{ $env.GOOGLE_CLIENT_ID }}&redirect_uri={{ $env.GOOGLE_REDIRECT_URI }}-dev&response_type=code&scope=https://www.googleapis.com/auth/calendar%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/userinfo.profile&access_type=offline&prompt=consent&state={{ $('Telegram Trigger').item.json.message.from.id }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -624,
        -16
      ],
      "id": "ef26ca68-3a40-4b8e-9b3c-842c993537e2",
      "name": "Send a text message6",
      "webhookId": "e9ef4d7d-ed3d-42de-9a5e-7b98d2790aa8",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a0a97375-e37c-41f4-a299-b1fafe2fff3c",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.contact }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Contact Shared"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cce7ea4f-5cd4-4e07-8820-5c9c1b082dbd",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": ".*–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å.*",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Get Invite Link"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6fce36ff-e64d-44a2-84fc-df7ceb67ae98",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message?.text }}",
                    "rightValue": "\\/start\\s+client_.*",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Client Subscription"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "843d53d7-cd81-4906-ba22-9cdd38a17000",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message?.text || $('Telegram Trigger').item.json.callback_query?.data }}",
                    "rightValue": "(\\/check|.*–ü—Ä–æ–≤–µ—Ä–∏—Ç—å.*|check_calendar)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Call T2 (Check)"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a83e7517-1e74-4207-b0b8-9a36f5405bb5",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message?.text || $('Telegram Trigger').item.json.callback_query?.data }}",
                    "rightValue": "(ask_|confirm_|cancel|start_parsing|.*–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É.*)",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Call T3 (Status)"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "312db1bd-29ac-4a6c-a396-cb7bd79816bb",
                    "leftValue": "={{ $('Get row(s)').item.json.onboarding_state === 'wait_display_name' && $('Telegram Trigger').item.json.message?.text && !$('Telegram Trigger').item.json.message?.text.startsWith('/') }}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Save Display Name"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e0d48501-25a8-418c-90d8-5a45f838a652",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message?.text }}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Start / New User"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c6522805-05e6-416a-9abb-3b23472b1c64",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message?.text || $('Telegram Trigger').item.json.callback_query?.data }}",
                    "rightValue": ".*–°–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏.*",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Free Slots"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b992b5e7-f739-4fa5-a790-761a09363d93",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Å—ã–ª–æ–∫",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Settings Clicked"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d3b79e71-8a0d-4a35-931d-9e7e5f8a3d5a",
                    "leftValue": "={{ $('Telegram Trigger').item.json.callback_query.data }}",
                    "rightValue": "nps_",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "NPS Answer"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b2a64fb9-ec18-4e39-b35c-e1a1b36f2f39",
                    "leftValue": "={{ $('Get Client Profile').item.json.input_mode }}",
                    "rightValue": "wait_feedback",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Feedback Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7f5cb7a0-c026-4ad8-b52c-d03236c26743",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "‚ùå –û—Ç–º–µ–Ω–∞",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancel Button"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8afa5e39-3ec8-443d-8e26-551b92b21573",
                    "leftValue": "={{ $('Telegram Trigger').item.json.callback_query.data }}",
                    "rightValue": "confirm_booking_",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirm Booking"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6e38d341-e6b0-47d9-b1f7-0d3a5fb91a81",
                    "leftValue": "={{ $('Telegram Trigger').item.json.callback_query.data }}",
                    "rightValue": "cancel_booking_",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancel Booking"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra",
          "allMatchingOutputs": true
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1296,
        -672
      ],
      "id": "d70363d8-93f6-439b-87dd-22331b9c5a16",
      "name": "Router"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "yixtx4eC9r1PFAYb",
          "mode": "list",
          "cachedResultName": "AireminderTest_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/yixtx4eC9r1PFAYb"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "keyValue": "={{ $('Code in JavaScript2').item.json.telegram_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_id": "={{ $('Code in JavaScript2').item.json.telegram_id }}",
            "phone": "={{ $('Code in JavaScript2').item.json.clean_phone }}",
            "name": "={{ $json.client_name || $('Code in JavaScript2').item.json.first_name }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "sent_at",
              "displayName": "sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "last_invite_sent_at",
              "displayName": "last_invite_sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -384,
        -1440
      ],
      "id": "45b6f83f-ffa5-466b-9fec-4c72084cd1a5",
      "name": "Upsert row(s)3"
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "=–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ $('Upsert row(s)3').item.json.name }}! üëã\n‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏ –æ–Ω–ª–∞–π–Ω:\n",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "üìÖ –û–∫–æ—à–∫–∏",
                    "additionalFields": {
                      "web_app": {
                        "url": "=https://t.me/pmn8nbot_bot/remi_dev?startapp=client_{{ $('Upsert row(s)3').item.json.linked_master_id }}"
                      }
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -176,
        -1440
      ],
      "id": "3bb9a1fd-7d95-49ed-b1d4-4266dcf9660d",
      "name": "Send a text message7",
      "webhookId": "0d89fe26-b504-444e-af75-d9f22e793c9f",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "d9de5f4a-0b7e-41cd-816d-467e5a051002",
              "leftValue": "$json.id",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "84c19f9d-0634-41c1-a242-0ac06e4548af",
              "leftValue": "$json.display_name",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            },
            {
              "id": "fbb6d405-f73e-46d0-a8ef-e0b2d24522b6",
              "leftValue": "$json.message.text",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notStartsWith"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -624,
        -192
      ],
      "id": "31b3a61a-7753-4f9d-adbb-d8f1b2f9d2fc",
      "name": "Check if Name Needed1"
    },
    {
      "parameters": {
        "chatId": "={{$json.message.chat.id}}",
        "text": "‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω!  –û—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥. –ù–∞–ø–∏—à–∏—Ç–µ –≤ –æ—Ç–≤–µ—Ç, –∫–∞–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –≤–∞—Å –∫–ª–∏–µ–Ω—Ç–∞–º –≤ SMS? (–ù–∞–ø—Ä–∏–º–µ—Ä: –ï–ª–µ–Ω–∞ / –°—Ç—É–¥–∏—è Beauty / –î–æ–∫—Ç–æ—Ä –ê–Ω–Ω–∞)",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -416,
        -112
      ],
      "id": "6e2c9731-e431-4663-8fef-a5601596bfd5",
      "name": "Ask Name1",
      "webhookId": "4f0180b1-1cc0-4fcc-9fbe-9b87f376e44b",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{$json.message.from.id}}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "is_active": false,
            "onboarding_state": "wait_display_name"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_google_email",
              "displayName": "master_google_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_name",
              "displayName": "master_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "display_name",
              "displayName": "display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "display_name_dat",
              "displayName": "display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "onboarding_state",
              "displayName": "onboarding_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -288,
        -192
      ],
      "id": "4e248b3d-ec58-4e75-8599-425ae5490383",
      "name": "Set Onboarding State2"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "display_name": "={{ $('Telegram Trigger').item.json.message.text.trim() }}",
            "onboarding_state": "done"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "display_name",
              "displayName": "display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "onboarding_state",
              "displayName": "onboarding_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -816,
        -352
      ],
      "id": "08cdfaca-0756-4493-bc5d-268aec065157",
      "name": "Save Display Name1"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=–ó–∞–¥–∞—á–∞: –°–∫–ª–æ–Ω–∏—Ç—å –∏–º—è –º–∞—Å—Ç–µ—Ä–∞ –≤ –î–ê–¢–ï–õ–¨–ù–´–ô –ø–∞–¥–µ–∂ (–æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å \"–∫–æ–º—É?\" - –∫ –º–∞—Å—Ç–µ—Ä—É ...).\n\n–í—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: \"{{ $('Telegram Trigger').item.json.message.text }}\"\n\n–ü–†–ê–í–ò–õ–ê:\n1. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON: { \"dative_name\": \"...\" }\n2. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –ò–º—è –∏ –§–∞–º–∏–ª–∏—è ‚Äî —Å–∫–ª–æ–Ω—è–π –û–ë–ê —Å–ª–æ–≤–∞. –ù–ï –¢–ï–†–Ø–ô —Ñ–∞–º–∏–ª–∏—é!\n3. –ï—Å–ª–∏ –∏–º—è —Ä—É—Å—Å–∫–æ–µ (–ï–ª–µ–Ω–∞, –ê–Ω–Ω–∞) -> —Å–∫–ª–æ–Ω—è–π (–ï–ª–µ–Ω–µ, –ê–Ω–Ω–µ).\n4. –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—É–¥–∏–∏, –±—Ä–µ–Ω–¥ –∏–ª–∏ –ª–∞—Ç–∏–Ω–∏—Ü–∞ -> –≤–µ—Ä–Ω–∏ –ö–ê–ö –ï–°–¢–¨.\n5. –ù–ï –¥–æ–±–∞–≤–ª—è–π —Å–ª–æ–≤–∞ \"–º–∞—Å—Ç–µ—Ä\", \"–∫\", \"–∑–∞–ø–∏—Å—å\". –¢–æ–ª—å–∫–æ —Å–∞–º–æ –∏–º—è.\n\n–ü—Ä–∏–º–µ—Ä—ã:\n\"–ï–ª–µ–Ω–∞\" -> \"–ï–ª–µ–Ω–µ\"\n\"–ï–ª–µ–Ω–∞ –°–µ–≤–∞—Å—Ç—å—è–Ω–æ–≤–∞\" -> \"–ï–ª–µ–Ω–µ –°–µ–≤–∞—Å—Ç—å—è–Ω–æ–≤–æ–π\"\n\"–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤\" -> \"–ò–≤–∞–Ω—É –ü–µ—Ç—Ä–æ–≤—É\"\n\"Beauty Bar\" -> \"Beauty Bar\""
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1,
      "position": [
        -624,
        -368
      ],
      "id": "b939b4a4-ebc3-4bca-96e7-094ffcf9c4bb",
      "name": "AI Inflect Dative1",
      "credentials": {
        "openAiApi": {
          "id": "KqSsgFJz89NymcBR",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã (–∏–≤–∞–Ω -> –ò–≤–∞–Ω)\nfunction toTitleCase(str) {\n    if (!str) return str;\n    return str.toLowerCase().replace(/(^|\\s)\\S/g, (L) => L.toUpperCase());\n}\n\n// 1. –ü–æ–ª—É—á–∞–µ–º –ò–°–•–û–î–ù–û–ï –∏–º—è\nconst triggerData = $('Telegram Trigger').item.json;\nconst src = (triggerData.message.text || '').trim();\n\n// 2. –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò\nlet aiResponse = null;\n\nif ($json.dative_name) {\n    aiResponse = $json.dative_name;\n} \nelse if ($json.message?.content?.dative_name) {\n    aiResponse = $json.message.content.dative_name;\n}\nelse {\n    const rawContent = $json.message?.content || $json.output || $json.text;\n    if (typeof rawContent === 'string') {\n        try {\n            const clean = rawContent.replace(/```json/g, '').replace(/```/g, '').trim();\n            const parsed = JSON.parse(clean);\n            aiResponse = parsed.dative_name;\n        } catch (e) {}\n    }\n}\n\nlet dative = (aiResponse || '').trim();\nlet reason = \"Success\";\n\n// --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü–†–û–í–ï–†–ö–ê –Ø–ó–´–ö–ê ---\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–º–µ–Ω–∏ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã\nconst hasCyrillic = /[–∞-—è–ê-–Ø—ë–Å]/.test(src);\n\nif (!hasCyrillic) {\n    // –ï—Å–ª–∏ —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤ –Ω–µ—Ç (Elena, John, Beauty Studio) -> –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å!\n    dative = src;\n    reason = \"Latin input: kept original\";\n} \nelse {\n    // –ï—Å–ª–∏ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –µ—Å—Ç—å -> –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å–∫–ª–æ–Ω–µ–Ω–∏—è\n    if (!dative) {\n        dative = src;\n        reason = \"Fallback: AI returned empty\";\n    }\n    else if (/\\b(–º–∞—Å—Ç–µ—Ä|–∫|–∑–∞–ø–∏—Å—å|–≤–∏–∑–∏—Ç)\\b/i.test(dative)) {\n        dative = src;\n        reason = \"Fallback: AI added extra words\";\n    }\n    else if (src.length > 0 && (dative.length > src.length * 3 || dative.length < src.length * 0.2)) {\n        dative = src;\n        reason = \"Fallback: Length mismatch\";\n    }\n}\n\n// –§–ò–ù–ê–õ–¨–ù–´–ô –®–¢–†–ò–•: –î–µ–ª–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ\nconst finalPrettyName = toTitleCase(dative);\n\nreturn [{\n    json: {\n        original_name: src,\n        final_dative: finalPrettyName,\n        _debug_reason: reason\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        -368
      ],
      "id": "d717312b-4237-4f7b-b973-de1570fd9d31",
      "name": "Validate Inflection1"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "display_name_dat": "={{ $json.final_dative }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "display_name_dat",
              "displayName": "display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -160,
        -368
      ],
      "id": "e5fc8a06-0f66-4fe4-abb2-b6269edf53d1",
      "name": "Save Dative Name1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "=üëç –ü—Ä–∏–Ω—è—Ç–æ, {{ $json.display_name }}!\n\n–¢–µ–ø–µ—Ä—å –∫–ª–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–¥–ø–∏—Å—å—é:\nüí¨ ¬´...–∂–¥—ë–º –≤–∞—Å! –° —É–≤–∞–∂–µ–Ω–∏–µ–º, {{ $json.display_name }}¬ª\n\nüëá –û—Ç–∫—Ä–æ–π –º–µ–Ω—é, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        48,
        -368
      ],
      "id": "b114de6d-1805-416a-a217-2444feb422b1",
      "name": "Confirm Setup1",
      "webhookId": "08545a9c-7e51-4066-b407-ec3761dbdc07",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "ImgY6WjvGc1Eg0tC",
          "mode": "list",
          "cachedResultUrl": "/workflow/ImgY6WjvGc1Eg0tC",
          "cachedResultName": "C2 DEV"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "mode": "each",
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -800,
        -864
      ],
      "id": "15a62920-d3b9-4cbb-be14-403b3e9dea84",
      "name": "Call 'T2'1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –¢—Ä–∏–≥–≥–µ—Ä–∞ (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)\n// –ò—Å–ø–æ–ª—å–∑—É–µ–º .first(), —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –ø–æ—Ä—è–¥–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤\nconst triggerData = $('Telegram Trigger').first().json;\n\n// 2. –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª–µ–∑–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É\nconst callback = triggerData.callback_query;\n// –ï—Å–ª–∏ –±—ã–ª callback, –±–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –Ω–µ–≥–æ, –∏–Ω–∞—á–µ –±–µ—Ä–µ–º —Å–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\nconst message = callback ? callback.message : triggerData.message;\n\n// –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–∑–∞—â–∏—Ç–∞ –æ—Ç undefined)\nconst text = triggerData.message?.text || \"\";\n\n// 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ\nlet action = null;\n\nif (callback) {\n    // –í–ê–†–ò–ê–ù–¢ –ê: –ù–∞–∂–∞—Ç–∞ Inline-–∫–Ω–æ–ø–∫–∞ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)\n    // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ, —á—Ç–æ –±—ã–ª–æ –∑–∞—à–∏—Ç–æ –≤ –∫–Ω–æ–ø–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'ask_start')\n    action = callback.data;\n} \nelse if (text.includes('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É')) {\n    // –í–ê–†–ò–ê–ù–¢ –ë: –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é (–Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞)\n    // .includes() –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å–º–∞–π–ª–∏–∫–∏ üöÄ –∏ –ø—Ä–æ–±–µ–ª—ã\n    action = 'ask_start';\n}\n\nreturn {\n  json: {\n    action: action,\n    chat_id: message ? message.chat.id : null,\n    message_id: message ? message.message_id : null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        -512
      ],
      "id": "4172c4e0-d202-459b-8484-e1ea0ba3add0",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $('Webhook1').item.json.query.state }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "master_telegram_id": "={{ $('Webhook1').item.json.query.state }}",
            "master_google_email": "={{ $json.email }}",
            "master_name": "={{ $json.name }}",
            "refresh_token": "={{ $('HTTP Request2').item.json.refresh_token }}",
            "onboarding_state": "wait_display_name",
            "timezone": "={{ $('HTTP Request (Get Settings)').item.json.timeZone }}",
            "is_active": false
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_google_email",
              "displayName": "master_google_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_name",
              "displayName": "master_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "display_name",
              "displayName": "display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name_dat",
              "displayName": "display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "onboarding_state",
              "displayName": "onboarding_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "slot_duration",
              "displayName": "slot_duration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "yandex_map_link",
              "displayName": "yandex_map_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "input_mode",
              "displayName": "input_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "timezone",
              "displayName": "timezone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -592,
        1456
      ],
      "id": "dfebec2a-fbd0-4306-a572-fae6482baefb",
      "name": "Upsert row(s)1"
    },
    {
      "parameters": {
        "jsCode": "// –Ø–≤–Ω–æ –±–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –¢—Ä–∏–≥–≥–µ—Ä–∞, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–æ–¥–∞ –º–æ–≥–ª–∞ –∏—Ö –∑–∞—Ç–µ—Ä–µ—Ç—å\nconst triggerData = $('Telegram Trigger').item.json;\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π\nif (!triggerData.message || !triggerData.message.contact) {\n  // –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –Ω–µ—Ç (—Å—Ç—Ä–∞–Ω–Ω–æ, –Ω–æ –±—ã–≤–∞–µ—Ç), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π\n  return [{ json: { error: \"No contact found\" } }];\n}\n\nconst contact = triggerData.message.contact;\nlet phone = contact.phone_number;\n\n// –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã\nphone = phone.replace(/\\D/g, '');\n\n// –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8 (–†–§), –º–µ–Ω—è–µ–º –Ω–∞ 7\nif (phone.length === 11 && phone.startsWith('8')) {\n  phone = '7' + phone.slice(1);\n}\n\nreturn [{\n  json: {\n    clean_phone: phone,\n    telegram_id: contact.user_id,\n    first_name: contact.first_name,\n    last_name: contact.last_name || \"\"\n  }\n}];\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        -1440
      ],
      "id": "62d01b4e-cb19-49d5-ba90-207e495e38ff",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "client_phone",
              "keyValue": "={{ $('Code in JavaScript2').item.json.clean_phone }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -592,
        -1440
      ],
      "id": "f3df50ac-9de4-4269-8dc5-170968ba6fe2",
      "name": "Get Real Name1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "httpMethod": "={{ \"OPTIONS\" }}",
        "path": "save-schedule-dev",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              },
              {
                "name": "Access-Control-Max-Age",
                "value": "86400"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1216,
        3552
      ],
      "id": "14a29f22-1cc8-4c46-a4bd-7ba00a5b2fbc",
      "name": "Webhook (OPTIONS)",
      "webhookId": "189ab813-7b36-4298-992a-e5329c18eba6"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "save-schedule-dev",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1216,
        3952
      ],
      "id": "f425f303-8777-452d-a058-996b61e2a748",
      "name": "Webhook (POST)",
      "webhookId": "38424816-0853-48e0-997f-487d918f8c1b"
    },
    {
      "parameters": {
        "jsCode": "// –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –í–µ–±—Ö—É–∫–∞\nconst body = $('Webhook (POST)').item.json.body;\n\n// –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –≤—ã—Ö–æ–¥–∏–º\nif (!body || !body.dates) return [];\n\nconst masterId = body.master_id;\nconst dates = body.dates || [];\nconst start = body.start;\nconst end = body.end;\nconst breaks = body.breaks || [];\n\nconst results = [];\n\nfor (const date of dates) {\n    results.push({\n        json: {\n            unique_key: `${masterId}_${date}`,\n            master_telegram_id: masterId.toString(),\n            work_date: date,\n            start_time: start,\n            end_time: end,\n            breaks: JSON.stringify(breaks)\n        }\n    });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -992,
        3952
      ],
      "id": "9554239e-3e77-4cd4-bf01-96bf6e9becb0",
      "name": "Process Data"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "5HSB7mDxSAKX0DBs",
          "mode": "list",
          "cachedResultName": "master_schedule_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5HSB7mDxSAKX0DBs"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "unique_key",
              "keyValue": "={{ $json.unique_key }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "master_telegram_id": "={{ $json.master_telegram_id }}",
            "work_date": "={{ $json.work_date }}",
            "start_time": "={{ $json.start_time }}",
            "end_time": "={{ $json.end_time }}",
            "unique_key": "={{ $json.unique_key }}",
            "breaks": "={{ $json.breaks }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "unique_key",
              "displayName": "unique_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "work_date",
              "displayName": "work_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "start_time",
              "displayName": "start_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "end_time",
              "displayName": "end_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "breaks",
              "displayName": "breaks",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -768,
        3952
      ],
      "id": "e6b0f86a-4973-475a-90b5-07d5ea925bba",
      "name": "Save to DB"
    },
    {
      "parameters": {
        "path": "save-schedule-dev",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1216,
        4208
      ],
      "id": "2d648705-3bfa-449f-ad0b-25f6ff0bdb45",
      "name": "Webhook (GET)",
      "webhookId": "f0a6dd5d-12d6-4b7a-af34-8771b74b2566"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5HSB7mDxSAKX0DBs",
          "mode": "list",
          "cachedResultName": "master_schedule_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5HSB7mDxSAKX0DBs"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ ($('Webhook (GET)').first().json.query.master_id || '').toString() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -784,
        4208
      ],
      "id": "fb561117-a6ef-4c0a-8fd5-0c9060fa3c32",
      "name": "Get from DB",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -352,
        4208
      ],
      "id": "6e6afaaf-d754-4416-b55d-ec95a5b1ce11",
      "name": "Return Data"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —è –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.",
        "replyMarkup": "replyKeyboard",
        "replyKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "üì± –ü–æ–¥–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
                    "additionalFields": {
                      "request_contact": true
                    }
                  }
                ]
              }
            }
          ]
        },
        "replyKeyboardOptions": {
          "resize_keyboard": true
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -384,
        -1024
      ],
      "id": "13975aab-4614-492b-8437-b1d09fe268b9",
      "name": "Send a text message1",
      "webhookId": "21d4ac60-2183-4934-b0c2-94116740286b",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://oauth2.googleapis.com/token",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "refresh_token",
              "value": "={{ $('Get Master OAuth').item.json.refresh_token }}"
            },
            {
              "name": "grant_type",
              "value": "refresh_token"
            },
            {
              "name": "client_id",
              "value": "={{ $env.GOOGLE_CLIENT_ID }}"
            },
            {
              "name": "client_secret",
              "value": "={{ $env.GOOGLE_CLIENT_SECRET }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        288,
        -192
      ],
      "id": "ecb02dcf-bd0d-4e5c-89a6-094132e85243",
      "name": "Refresh Token (Slots)"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/calendar/v3/calendars/primary/events",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "timeMin",
              "value": "={{ $now.setZone('Europe/Moscow').toISO() }}"
            },
            {
              "name": "timeMax",
              "value": "={{ $now.setZone('Europe/Moscow').plus({ days: 7 }).toISO() }}"
            },
            {
              "name": "singleEvents",
              "value": "true"
            },
            {
              "name": "orderBy",
              "value": "startTime"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Refresh Token (Slots)').item.json.access_token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        496,
        -192
      ],
      "id": "6bdc1409-9b3b-4708-ab06-220ef7c0c909",
      "name": "Get GCal (Slots)"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5HSB7mDxSAKX0DBs",
          "mode": "list",
          "cachedResultName": "master_schedule_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5HSB7mDxSAKX0DBs"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $('Setup Context').item.json.master_id }}"
            },
            {
              "keyName": "work_date",
              "condition": "gte",
              "keyValue": "={{ $now.minus({days: 1}).toFormat('yyyy-MM-dd') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        272,
        176
      ],
      "id": "1ce45c32-cbdc-42c8-a8a0-7e077b5b9130",
      "name": "Get DB Schedule (Slots)"
    },
    {
      "parameters": {
        "jsCode": "// 1. –ù–ê–°–¢–†–û–ô–ö–ò\nconst contextNode = $('Setup Context').first();\nconst context = contextNode ? contextNode.json : {};\nconst targetDatesStr = context.target_dates || [];\nconst chatId = context.client_id || context.master_id;\n\nlet masterTz = 'Europe/Moscow'; \nlet masterDuration = 60;\n\ntry {\n    const masterProfileNode = $('Get Master OAuth').first();\n    if (masterProfileNode) {\n        if (masterProfileNode.json.timezone) masterTz = masterProfileNode.json.timezone;\n        if (masterProfileNode.json.slot_duration) masterDuration = parseInt(masterProfileNode.json.slot_duration);\n    }\n} catch(e) {}\n\n// 2. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• (–ê–í–¢–û-–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ò–°–¢–û–ß–ù–ò–ö–ê)\nlet rawSourceA = [];\nlet rawSourceB = [];\n\ntry { rawSourceA = $('Get DB Schedule (Slots)').all().map(i => i.json); } catch (e) {}\ntry { rawSourceB = $('Get DB Schedule (Slots)1').all().map(i => i.json); } catch (e) {}\n\nlet workSchedules = [];\nlet appointments = [];\n\n// –§—É–Ω–∫—Ü–∏—è-–¥–µ—Ç–µ–∫—Ç–æ—Ä: –•—É –∏–∑ –•—É?\nfunction detectSource(data) {\n    if (!data || data.length === 0) return;\n    // –ï—Å–ª–∏ –µ—Å—Ç—å work_date -> –≠—Ç–æ –ì—Ä–∞—Ñ–∏–∫\n    if (data[0].work_date) {\n        workSchedules = data;\n    } \n    // –ï—Å–ª–∏ –µ—Å—Ç—å appointment_time -> –≠—Ç–æ –ó–∞–ø–∏—Å–∏\n    else if (data[0].appointment_time) {\n        appointments = data;\n    }\n}\n\ndetectSource(rawSourceA);\ndetectSource(rawSourceB);\n\nconst freeSlots = [];\n\n// 3. –¶–ò–ö–õ\nfor (const dateStr of targetDatesStr) {\n    // –ò—â–µ–º –≥—Ä–∞—Ñ–∏–∫ (–£–º–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç)\n    const targetDate = DateTime.fromISO(dateStr, { zone: masterTz });\n    \n    const schedule = workSchedules.find(s => {\n        if (!s.work_date) return false;\n        // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–∞–∫ –¥–∞—Ç—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Ñ–æ—Ä–º–∞—Ç–∞\n        return DateTime.fromISO(s.work_date, { zone: masterTz }).hasSame(targetDate, 'day');\n    });\n\n    if (!schedule) continue; // –ù–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ -> –í—ã—Ö–æ–¥–Ω–æ–π\n\n    // –ì—Ä–∞–Ω–∏—Ü—ã –¥–Ω—è\n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º dateStr –∏–∑ —Ü–∏–∫–ª–∞, —á—Ç–æ–±—ã –¥–∞—Ç–∞ —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–ª–∞\n    const workStart = DateTime.fromFormat(`${dateStr} ${schedule.start_time}`, 'yyyy-MM-dd HH:mm', { zone: masterTz });\n    const workEnd = DateTime.fromFormat(`${dateStr} ${schedule.end_time}`, 'yyyy-MM-dd HH:mm', { zone: masterTz });\n\n    // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∑–∞–Ω—è—Ç–æ—Å—Ç–∏\n    let busyIntervals = [];\n    \n    // –ü–µ—Ä–µ—Ä—ã–≤—ã\n    if (schedule.breaks) {\n        try {\n            const breaks = typeof schedule.breaks === 'string' ? JSON.parse(schedule.breaks) : schedule.breaks;\n            breaks.forEach(b => {\n                const bStart = DateTime.fromFormat(`${dateStr} ${b.start}`, 'yyyy-MM-dd HH:mm', { zone: masterTz });\n                const bEnd = DateTime.fromFormat(`${dateStr} ${b.end}`, 'yyyy-MM-dd HH:mm', { zone: masterTz });\n                busyIntervals.push({ start: bStart, end: bEnd });\n            });\n        } catch (e) {}\n    }\n\n    // –ö–ª–∏–µ–Ω—Ç—ã\n    appointments.forEach(ev => {\n        if (!ev.appointment_time || !ev.appointment_end_time) return;\n        const appStart = DateTime.fromISO(ev.appointment_time).setZone(masterTz);\n        const appEnd = DateTime.fromISO(ev.appointment_end_time).setZone(masterTz);\n\n        if (appStart.hasSame(targetDate, 'day')) {\n            busyIntervals.push({ start: appStart, end: appEnd });\n        }\n    });\n    \n    busyIntervals.sort((a, b) => a.start - b.start);\n\n    // –ü–æ–∏—Å–∫\n    let pointer = workStart;\n    const now = DateTime.now().setZone(masterTz);\n    \n    if (pointer.hasSame(now, 'day') && pointer < now) {\n        const remainder = 30 - (now.minute % 30);\n        pointer = now.plus({ minutes: remainder }).set({ second: 0, millisecond: 0 });\n    }\n\n    while (pointer < workEnd) {\n        const potentialEnd = pointer.plus({ minutes: masterDuration });\n        if (potentialEnd > workEnd) break;\n\n        let collision = null;\n        for (const busy of busyIntervals) {\n            if (pointer < busy.end && potentialEnd > busy.start) {\n                collision = busy;\n                break;\n            }\n        }\n\n        if (collision) {\n            pointer = collision.end;\n        } else {\n            freeSlots.push({\n                date: targetDate.toFormat('dd.MM'),\n                dayOfWeek: targetDate.setLocale('ru').toFormat('cccc'),\n                time: pointer.toFormat('HH:mm')\n            });\n            pointer = pointer.plus({ minutes: masterDuration });\n        }\n    }\n}\n\nreturn {\n    json: {\n        chat_id: chatId,\n        role: context.role,\n        free_slots: freeSlots,\n        slots_count: freeSlots.length\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        480,
        176
      ],
      "id": "e2a6b0bb-9f7c-4ee7-a2cc-28d745e9a7bd",
      "name": "Calculate Free Slots"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "responses": {
          "values": [
            {
              "role": "system",
              "content": "{{ $json.role === 'client' ? '–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø—Ä–æ—Å—Ç–æ –∏ —á–µ—Ç–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É —Å–ø–∏—Å–æ–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω –≤—ã–±—Ä–∞–ª. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π SMM-—Å—Ç–∏–ª—å, –Ω–µ –ø–∏—à–∏ \"–£—Å–ø–µ–π –∑–∞–ø–∏—Å–∞—Ç—å—Å—è\", –ø—Ä–æ—Å—Ç–æ —Ñ–∞–∫—Ç—ã. –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ –í—ã.' : '–¢—ã ‚Äî SMM-–ø–æ–º–æ—â–Ω–∏–∫ –±—å—é—Ç–∏-–º–∞—Å—Ç–µ—Ä–∞. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π, –ø—Ä–æ–¥–∞—é—â–∏–π –ø–æ—Å—Ç –¥–ª—è —Å—Ç–æ—Ä–∏—Å –∏–ª–∏ –∫–∞–Ω–∞–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, —Å–æ–∑–¥–∞–π —Å—Ä–æ—á–Ω–æ—Å—Ç—å.' }}"
            },
            {
              "content": "={{ $json.role === 'client' ? '–ö–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª —ç—Ç–∏ –¥–∞—Ç—ã. –í–æ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏:\\n' + JSON.stringify($json.free_slots) + '\\n\\n–ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\\n\"üìÖ [–î–∞—Ç–∞]: [–í—Ä–µ–º—è], [–í—Ä–µ–º—è]\"\\n–í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å: \"–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è –≤ –æ—Ç–≤–µ—Ç.\"' : '–í–æ—Ç —Å–ø–∏—Å–æ–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ—à–µ–∫:\\n' + JSON.stringify($json.free_slots) + '\\n\\n–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç. –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é: \"–ü–∏—à–∏—Ç–µ –≤ –ª–∏—á–∫—É –¥–ª—è –∑–∞–ø–∏—Å–∏\".' }}"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        688,
        176
      ],
      "id": "48edb2bc-92aa-4212-b9ab-5c51328e6b3f",
      "name": "AI Generate Post",
      "credentials": {
        "openAiApi": {
          "id": "KqSsgFJz89NymcBR",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Calculate Free Slots').first().json.chat_id }}",
        "text": "={{ $json.output[0].content[0].text }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1040,
        176
      ],
      "id": "c8698940-7eb5-4d90-becf-fc2377257497",
      "name": "Send Slots Post",
      "webhookId": "57d371f3-08d1-4a44-9759-3dcac31cccf7",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $json.body.master_id.toString() }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "slot_duration": "={{ $json.body.slot_duration }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_google_email",
              "displayName": "master_google_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_name",
              "displayName": "master_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name",
              "displayName": "display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name_dat",
              "displayName": "display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "onboarding_state",
              "displayName": "onboarding_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "slot_duration",
              "displayName": "slot_duration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -848,
        3760
      ],
      "id": "6fb5a9f5-d95f-4ce6-9fc1-dc0ce42192a9",
      "name": "Update Master Duration"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "get-free-slots-dev",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -816,
        176
      ],
      "id": "3bb8bbf0-a783-49dc-a321-9996607a25a2",
      "name": "Webhook (Free Slots)",
      "webhookId": "c0835da8-eb43-4ba7-ae3a-8c0fda5f4610"
    },
    {
      "parameters": {
        "jsCode": "const now = DateTime.now().setZone('Europe/Moscow');\n\nlet webhookData = null;\nlet triggerData = null;\n\ntry { webhookData = $('Webhook (Free Slots)').first().json.body; } catch (e) {}\ntry { triggerData = $('Telegram Trigger').first().json.message; } catch (e) {}\n\nlet masterId = null;\nlet clientId = null; // ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è –æ—Ç–≤–µ—Ç–∞\nlet targetDates = [];\nlet source = '';\nlet role = 'master'; // master | client\n\nif (webhookData) {\n    // –ó–ê–ü–£–°–ö –ò–ó –ú–ò–ù–ò-–ü–†–ò–õ–û–ñ–ï–ù–ò–Ø\n    source = 'miniapp';\n    masterId = webhookData.master_id ? webhookData.master_id.toString() : null;\n    \n    // –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª client_id, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç —Å–º–æ—Ç—Ä–∏—Ç –≥—Ä–∞—Ñ–∏–∫ –º–∞—Å—Ç–µ—Ä–∞\n    if (webhookData.client_id) {\n        clientId = webhookData.client_id.toString();\n        role = 'client';\n    } else {\n        // –ò–Ω–∞—á–µ —ç—Ç–æ —Å–∞–º –º–∞—Å—Ç–µ—Ä —Å–º–æ—Ç—Ä–∏—Ç —Å–≤–æ–π –≥—Ä–∞—Ñ–∏–∫\n        clientId = masterId;\n        role = 'master';\n    }\n\n    if (webhookData.dates && Array.isArray(webhookData.dates)) {\n        targetDates = webhookData.dates;\n    }\n} else if (triggerData) {\n    // –ó–ê–ü–£–°–ö –ß–ï–†–ï–ó –ß–ê–¢ (–ö–Ω–æ–ø–∫–∞) - –≠—Ç–æ –≤—Å–µ–≥–¥–∞ –º–∞—Å—Ç–µ—Ä\n    source = 'chat';\n    masterId = triggerData.from.id.toString();\n    clientId = masterId;\n    role = 'master';\n    \n    for (let i = 0; i < 7; i++) {\n        targetDates.push(now.plus({ days: i }).toFormat('yyyy-MM-dd'));\n    }\n} else {\n    return { json: { error: \"No input source detected\" } };\n}\n\nreturn {\n    json: {\n        master_id: masterId,\n        client_id: clientId, // –ö–æ–º—É —Å–ª–∞—Ç—å –æ—Ç–≤–µ—Ç\n        role: role,          // –†–æ–ª—å –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ –ò–ò\n        target_dates: targetDates,\n        source: source\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        176
      ],
      "id": "df994dfe-06cd-47fb-bf62-c553657dffb2",
      "name": "Setup Context"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $('Setup Context').item.json.master_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -368,
        176
      ],
      "id": "7a6dfe3f-a496-4730-9c49-75b94f2868c9",
      "name": "Get Master OAuth"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              },
              {
                "name": "Access-Control-Max-Age",
                "value": "86400"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1024,
        1216
      ],
      "id": "07ab4fce-9c10-43f0-aa3e-b30d1817ce61",
      "name": "Respond (CORS)"
    },
    {
      "parameters": {
        "httpMethod": "={{ \"OPTIONS\" }}",
        "path": "get-free-slots-dev",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1296,
        1216
      ],
      "id": "b49c992c-dc35-4a12-8b77-a15e256ebf39",
      "name": "Webhook (OPTIONS Slots)",
      "webhookId": "ff2d4d33-3db3-487f-9a21-17878875321b"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ ($json.query.master_id || '').toString() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -1008,
        4208
      ],
      "id": "ba8c07fb-16c8-4df6-ae3e-5d8ceab2a303",
      "name": "Get Master Profile",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// 1. –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ –≤–µ–±—Ö—É–∫–∞\nlet incomingId = null;\ntry {\n    incomingId = $('Webhook (GET)').first().json.query.master_id;\n} catch (e) {}\nconst finalId = incomingId ? incomingId.toString() : \"ERROR_MISSING_ID\";\n\n// 2. –ü–æ–ª—É—á–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø—É—Å—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤)\nlet schedule = [];\ntry {\n    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ\n    const rawItems = $('Get from DB').all().map(i => i.json);\n    \n    // –§–∏–ª—å—Ç—Ä—É–µ–º: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, work_date)\n    // –≠—Ç–æ –Ω—É–∂–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ \"Always Output Data\" –º–æ–∂–µ—Ç –ø—Ä–∏—Å–ª–∞—Ç—å –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç {}\n    schedule = rawItems.filter(item => item.work_date && item.unique_key);\n} catch (e) {}\n\n// 3. –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—Ç–µ—Ä–∞\nlet duration = 60;\ntry {\n    const profileItems = $('Get Master Profile').all();\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞–π–¥–µ–Ω (–µ—Å—Ç—å id)\n    if (profileItems.length > 0 && profileItems[0].json.id && profileItems[0].json.slot_duration) {\n        duration = parseInt(profileItems[0].json.slot_duration);\n    }\n} catch (e) {}\n\n// 4. –û—Ç–¥–∞–µ–º –æ—Ç–≤–µ—Ç\nreturn {\n    json: {\n        master_id: finalId,\n        settings: {\n            slot_duration: duration\n        },\n        schedule: schedule // –¢–µ–ø–µ—Ä—å –∑–¥–µ—Å—å –±—É–¥–µ—Ç —á–∏—Å—Ç—ã–π –º–∞—Å—Å–∏–≤ –∏–ª–∏ [], –Ω–æ –Ω–µ [{}]\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        4208
      ],
      "id": "a4d86fd9-bf8f-4a81-b35a-9d9962483f88",
      "name": "Merge Data"
    },
    {
      "parameters": {
        "jsCode": "const text = $('Telegram Trigger').item.json.message.text;\n// –û–∂–∏–¥–∞–µ–º \"/start client_12345\"\n// –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ \"client_\" –∏ –±–µ—Ä–µ–º –≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å\nconst parts = text.split('client_');\nconst masterId = parts.length > 1 ? parts[1] : null;\n\nreturn {\n  json: {\n    master_id: masterId,\n    client_telegram_id: $('Telegram Trigger').item.json.message.from.id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        -1024
      ],
      "id": "5892adf7-f34f-4590-ac07-eb99ec50bfd3",
      "name": "Code (Extract ID)"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "yixtx4eC9r1PFAYb",
          "mode": "list",
          "cachedResultName": "AireminderTest_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/yixtx4eC9r1PFAYb"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "keyValue": "={{ $json.client_telegram_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_id": "={{ $json.client_telegram_id }}",
            "linked_master_id": "={{ $json.master_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "linked_master_id",
              "displayName": "linked_master_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -608,
        -1024
      ],
      "id": "38d370a6-f435-455b-96cf-80b1bf5f8fd5",
      "name": "Upsert Link"
    },
    {
      "parameters": {
        "operation": "sendPhoto",
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "file": "=https://quickchart.io/qr?text=https://t.me/pmn8nbot_bot?start=client_{{ $('Telegram Trigger').item.json.message.from.id }}&size=500&margin=2",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -800,
        -1216
      ],
      "id": "bc21eb7a-7454-4a8c-9c4a-c10bcbe7a1e6",
      "name": "Send QR Code",
      "webhookId": "2cab6d2c-8c79-49fa-8335-05162bf00029",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "=üîó –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç—É —ç—Ç—É —Å—Å—ã–ª–∫—É:\n<a href=\"https://t.me/pmn8nbot_bot?start=client_{{ $('Telegram Trigger').item.json.message.from.id }}\">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è</a>",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -592,
        -1216
      ],
      "id": "ef5b30c1-3229-4894-9749-261edcb265e2",
      "name": "Send Link Text",
      "webhookId": "426b1097-d6de-4ec6-a60c-cd43da2f9c15",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. –ò—â–µ–º ID\n// –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –º–∞—Å—Ç–µ—Ä–∞ (–µ—Å–ª–∏ –æ–Ω –±—ã–ª –Ω–∞–π–¥–µ–Ω —Ä–∞–Ω–µ–µ)\nlet id = null;\ntry {\n    id = $('Get Master Profile').first().json.master_telegram_id;\n} catch (e) {}\n\n// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\nif (!id) {\n    try { id = $('Telegram Trigger').first().json.message.chat.id; } catch(e) {}\n}\n// –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –∏–∑ callback\nif (!id) {\n    try { id = $('Telegram Trigger').first().json.callback_query.message.chat.id; } catch(e) {}\n}\n\n// 2. –°—Å—ã–ª–∫–∏ –¥–ª—è Web App\nconst scheduleLink = 'https://heroinru.github.io/aireminder-app/index-dev.html?master_id=' + id + '&mode=master';\nconst confirmLink = 'https://heroinru.github.io/aireminder-app/index-dev.html?master_id=' + id + '&mode=confirm';\n\n// 3. –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ –¥–ª—è Telegram\nconst body = {\n  chat_id: id,\n  text: \"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ üëá\",\n  reply_markup: {\n    keyboard: [\n      [\n        {\n          text: \"üìÖ –ú–æ–π –ì—Ä–∞—Ñ–∏–∫ ‚≠êÔ∏è\",\n          web_app: { url: scheduleLink }\n        }\n      ],\n      [\n        {\n          text: \"‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∏–∑–∏—Ç—ã\",\n          web_app: { url: confirmLink }\n        }\n      ],\n      [\n        { text: \"üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞\" },\n        { text: \"üìÖ –°–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏\" }\n      ],\n      [\n        { text: \"üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å\" },\n        { text: \"üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É\" }\n      ],\n      [\n        { text: \"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Å—ã–ª–æ–∫\" } \n      ]\n    ],\n    resize_keyboard: true\n  }\n};\n\nreturn {\n    json: {\n        telegram_body: body\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        -896
      ],
      "id": "bdfe874d-fed5-47ee-ac2d-4da27fbf90fd",
      "name": "Get ID Like Blue Button"
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot8542710399:AAGUHcwwWeu4BT-4zJpol-BiNZ3ALrltT8A/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.telegram_body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        352,
        -896
      ],
      "id": "c85a5473-e01e-4e36-925a-bd679a8017b9",
      "name": "Send Menu HTTP"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -976,
        3552
      ],
      "id": "b583dc39-f615-4684-b9e1-38ff4827ac6d",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id.toString() }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "input_mode": "=wait_link"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_google_email",
              "displayName": "master_google_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_name",
              "displayName": "master_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name",
              "displayName": "display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name_dat",
              "displayName": "display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "onboarding_state",
              "displayName": "onboarding_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "slot_duration",
              "displayName": "slot_duration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "yandex_map_link",
              "displayName": "yandex_map_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "input_mode",
              "displayName": "input_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "dryRun": false
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -784,
        416
      ],
      "id": "f1cf76cd-4770-4fc2-b668-361c37b68298",
      "name": "Set Mode Wait"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à—É –∫–∞—Ä—Ç–æ—á–∫—É –≤ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞—Ö. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá",
        "replyMarkup": "replyKeyboard",
        "replyKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "‚ùå –û—Ç–º–µ–Ω–∞",
                    "additionalFields": {}
                  }
                ]
              }
            }
          ]
        },
        "replyKeyboardOptions": {
          "resize_keyboard": true,
          "one_time_keyboard": true
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -640,
        416
      ],
      "id": "d6be4361-f7de-4aaf-b9e4-ec9836e8168e",
      "name": "Pls_link",
      "webhookId": "016ea14e-b9b2-4337-882a-e26643af7e35",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Get row(s)').item.json.input_mode }}",
                    "rightValue": "wait_link",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "5f469652-6f58-4666-baf9-33ee51ae1b59"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Is Waiting Link"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "9ca59ae1-21fb-4386-b239-75f1e5c3e71d",
                    "leftValue": "={{ $json.input_mode }}",
                    "rightValue": "wait_feedback",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Client Feedback"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "6df5c59d-acb0-4046-9d3b-385faea4fab5",
                    "leftValue": "={{ $('Get row(s)').item.json.onboarding_state }}",
                    "rightValue": "wait_display_name",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Is Waiting Name"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -1696,
        -576
      ],
      "id": "483cb038-d0a2-4d2b-aaa8-812179eec7b4",
      "name": "Check Input Mode"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "6d62fd89-8d00-4d68-9475-e575fbb70431",
              "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
              "rightValue": "^https?:\\/\\/(yandex\\.ru\\/maps|yandex\\.com\\/maps|ya\\.ru)\\/.*",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2384,
        -976
      ],
      "id": "1d342678-d6a1-4241-8e36-2c5aa23fbad7",
      "name": "Validate Yandex URL"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "‚ùå –û—Ç–º–µ–Ω–∞",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "47160c5a-f10d-484c-8e32-b4ad8ef998ad"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancel Clicked"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Check Link"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -2592,
        -976
      ],
      "id": "ac174d67-cd36-4e26-8bc9-bb11b32401e4",
      "name": "Is Cancel?"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id.toString() }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "input_mode": "={{null}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_google_email",
              "displayName": "master_google_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_name",
              "displayName": "master_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name",
              "displayName": "display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name_dat",
              "displayName": "display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "onboarding_state",
              "displayName": "onboarding_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "slot_duration",
              "displayName": "slot_duration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "yandex_map_link",
              "displayName": "yandex_map_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "input_mode",
              "displayName": "input_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -2384,
        -1184
      ],
      "id": "5bcd6602-b7b7-4a33-bf96-4798224ffb95",
      "name": "Clear Mode"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "‚õîÔ∏è –≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å—Å—ã–ª–∫—É –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
        "replyMarkup": "replyKeyboard",
        "replyKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "‚ùå –û—Ç–º–µ–Ω–∞",
                    "additionalFields": {}
                  }
                ]
              }
            }
          ]
        },
        "replyKeyboardOptions": {},
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2192,
        -896
      ],
      "id": "b57fff32-0986-4492-9901-8cbe30ee4473",
      "name": "Send Error",
      "webhookId": "6741c9a3-59cc-44b8-a401-c32bae5f4225",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id.toString() }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "yandex_map_link": "={{ $('Telegram Trigger').item.json.message.text }}",
            "input_mode": "={{null}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_google_email",
              "displayName": "master_google_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_name",
              "displayName": "master_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name",
              "displayName": "display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "display_name_dat",
              "displayName": "display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "onboarding_state",
              "displayName": "onboarding_state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "slot_duration",
              "displayName": "slot_duration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "yandex_map_link",
              "displayName": "yandex_map_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "input_mode",
              "displayName": "input_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -2192,
        -1120
      ],
      "id": "2dafbfed-4170-41c3-8f6a-dcfd7ea1f126",
      "name": "Save Link DB"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "‚úÖ –°—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –¢–µ–ø–µ—Ä—å —è –±—É–¥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ—ë –∫–ª–∏–µ–Ω—Ç–∞–º.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1776,
        -1120
      ],
      "id": "c41b4f57-c22d-4f7e-b449-20a079ba5820",
      "name": "Msg: Saved",
      "webhookId": "2e2e58a2-c6ab-4c18-b525-18b24dd8cefd",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "c798LQrfJZ5d61Pz",
          "mode": "list",
          "cachedResultUrl": "/workflow/c798LQrfJZ5d61Pz",
          "cachedResultName": "C3 DEV"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "mode": "each",
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -608,
        -512
      ],
      "id": "e58e4f93-4eb3-4525-8ad0-8d7412a7d38c",
      "name": "Call 'C3 DEV'"
    },
    {
      "parameters": {
        "path": "get-visits-dev",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1216,
        -2144
      ],
      "id": "8eeed531-7ac5-48b7-803b-33f30cb19042",
      "name": "Webhook (GET Visits)",
      "webhookId": "9999cebd-e746-4839-a710-56a846fbb70a"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_ref_id",
              "keyValue": "={{ $('Find Master').first().json.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -848,
        -2144
      ],
      "id": "8dbe1e48-e0b8-44be-9e2d-3962e2065c98",
      "name": "Get All Appointments",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst now = DateTime.now().setZone('Europe/Moscow');\n\n// –ï—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç ‚Äî —Å—Ä–∞–∑—É –æ—Ç–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫\nif (items.length === 0 || !items[0].json.appointment_time) {\n    return { json: { visits: [] } };\n}\n\nconst start = now.minus({ days: 1 }).startOf('day');\nconst end = now.endOf('day');\n\nconst filtered = items.map(item => item.json).filter(appt => {\n    if (!appt.appointment_time) return false;\n    const apptTime = DateTime.fromISO(appt.appointment_time, { zone: 'Europe/Moscow' });\n    const inRange = apptTime >= start && apptTime <= end;\n    \n    const status = appt.visit_status || 'pending';\n    const show = status !== 'confirmed'; \n\n    return inRange && show;\n});\n\nfiltered.sort((a, b) => new Date(a.appointment_time) - new Date(b.appointment_time));\n\nreturn { json: { visits: filtered } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -640,
        -2144
      ],
      "id": "40a08bf3-a953-42ed-a4b7-cd9a05a7d412",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -432,
        -2144
      ],
      "id": "975cb00b-6298-4e09-8aae-3ac0326bc5c2",
      "name": "Respond to Webhook2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "save-visits-dev",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1232,
        -1920
      ],
      "id": "c8ad2c13-bd7b-48c6-a92c-03cedfb42e45",
      "name": "Webhook (POST Visits)",
      "webhookId": "80a22453-5dec-4728-bffe-ffdc1c730912"
    },
    {
      "parameters": {
        "httpMethod": "={{ \"OPTIONS\" }}",
        "path": "save-visits-dev",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1232,
        -1728
      ],
      "id": "8ea68c49-2582-445d-93d4-86fbe5c942cb",
      "name": "Webhook",
      "webhookId": "e0d829eb-a9cc-43df-a2aa-52e14733c48f"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              },
              {
                "name": "Access-Control-Max-Age",
                "value": "86400"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1024,
        -1728
      ],
      "id": "2d1f1f85-84c9-45ca-a5f2-756db2aa3c94",
      "name": "Respond (CORS)1"
    },
    {
      "parameters": {
        "jsCode": "const updates = $json.body.updates || [];\n// –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞–π—Ç–µ–º—ã\nreturn updates.map(u => ({\n    json: {\n        event_id: u.event_id,\n        visit_status: u.status\n    }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -992,
        -1920
      ],
      "id": "e9d4eeb0-7f8a-4cb8-83d3-eb2a0c361484",
      "name": "Code in JavaScript4"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "event_id",
              "keyValue": "={{ $json.event_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "visit_status": "={{ $json.visit_status }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "event_id",
              "displayName": "event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "client_name",
              "displayName": "client_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "service_type",
              "displayName": "service_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "appointment_time",
              "displayName": "appointment_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "reminder_sent",
              "displayName": "reminder_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "confirmation_status",
              "displayName": "confirmation_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "client_phone",
              "displayName": "client_phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "reminder_time",
              "displayName": "reminder_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_ref_id",
              "displayName": "master_ref_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "client_email",
              "displayName": "client_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_display_name",
              "displayName": "master_display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_display_name_dat",
              "displayName": "master_display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "google_etag",
              "displayName": "google_etag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "visit_status",
              "displayName": "visit_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -784,
        -1920
      ],
      "id": "104cfd1c-0583-4828-bb36-37b9d00765a0",
      "name": "Update Visit Status",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{ \"success\": true }",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -576,
        -1920
      ],
      "id": "f19be16a-e0ff-415e-b4db-05c94fd68703",
      "name": "Respond to Webhook3"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ $json.query.master_id.toString() }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -1024,
        -2144
      ],
      "id": "edf6ab63-90e3-44ed-9299-fde1f5128190",
      "name": "Find Master"
    },
    {
      "parameters": {
        "jsCode": "// 1. –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –¢—Ä–∏–≥–≥–µ—Ä–∞ (—Ç–∞–∫ –∫–∞–∫ –≤—Ö–æ–¥ –ø–µ—Ä–µ–∫—Ä—ã—Ç –¥–∞–Ω–Ω—ã–º–∏ –º–∞—Å—Ç–µ—Ä–∞)\nconst triggerData = $('Telegram Trigger').item.json;\nconst callbackData = triggerData.callback_query.data; // \"nps_5_abc123\"\n\n// 2. –ü–∞—Ä—Å–∏–º\nconst parts = callbackData.split('_');\nconst score = parseInt(parts[1]); // –û—Ü–µ–Ω–∫–∞\nconst eventId = parts.slice(2).join('_'); // ID —Å–æ–±—ã—Ç–∏—è\n\n// 3. –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞\nconst chatId = triggerData.callback_query.message.chat.id;\nconst messageId = triggerData.callback_query.message.message_id;\n\nreturn {\n    json: {\n        score: score,\n        event_id: eventId,\n        chat_id: chatId,\n        message_id: messageId\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -784,
        640
      ],
      "id": "d6485b9f-2c8e-443b-a2a5-72f71ce167ec",
      "name": "Code in JavaScript5"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "ST8dI3ftnXZnrS5V",
          "mode": "list",
          "cachedResultName": "feedback_history_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/ST8dI3ftnXZnrS5V"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "client_telegram_id",
              "keyValue": "={{ $json.chat_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "last_nps_score": "={{ $json.score }}",
            "client_telegram_id": "={{ $json.chat_id }}."
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "client_telegram_id",
              "displayName": "client_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "last_survey_date",
              "displayName": "last_survey_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "last_nps_score",
              "displayName": "last_nps_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "total_surveys",
              "displayName": "total_surveys",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -576,
        640
      ],
      "id": "d300c7de-30bf-46a1-9cd7-dd5e4c98fea3",
      "name": "Upsert row(s)"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Code in JavaScript5').item.json.score }}",
                    "rightValue": 5,
                    "operator": {
                      "type": "number",
                      "operation": "gte"
                    },
                    "id": "6874447d-4a1f-43f7-a7e7-b88464b5ce8b"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "367370bb-ad7c-440f-9773-a2f75a535339",
                    "leftValue": "={{ $('Code in JavaScript5').item.json.score }}",
                    "rightValue": 5,
                    "operator": {
                      "type": "number",
                      "operation": "lt"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -368,
        640
      ],
      "id": "5f0d7e41-12fb-4516-b1b0-88ea9fa32037",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Code in JavaScript5').item.json.chat_id }}",
        "messageId": "={{ $('Code in JavaScript5').item.json.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "–°–ø–∞—Å–∏–±–æ –æ–≥—Ä–æ–º–Ω–æ–µ! ‚ù§Ô∏è –í—ã ‚Äî –ª—É—á—à–∏–π –∫–ª–∏–µ–Ω—Ç!  –ë—É–¥–µ–º —Å—á–∞—Å—Ç–ª–∏–≤—ã, –µ—Å–ª–∏ –≤—ã –Ω–∞–ø–∏—à–µ—Ç–µ –ø–∞—Ä—É —Å–ª–æ–≤ –Ω–∞ –ö–∞—Ä—Ç–∞—Ö ‚Äî —ç—Ç–æ –æ—á–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º —Ä–∞—Å—Ç–∏.",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "üó∫ –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤",
                    "additionalFields": {
                      "url": "={{ $('Get Master Link').item.json.yandex_map_link }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        544,
        368
      ],
      "id": "d4dfc26f-5284-4c78-8e53-ce111d0df335",
      "name": "Edit a text message",
      "webhookId": "81687f11-ae39-4dae-80f0-60d726f2e9d5",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Code in JavaScript5').item.json.chat_id }}",
        "messageId": "={{ $('Code in JavaScript5').item.json.message_id }}",
        "text": "–°–ø–∞—Å–∏–±–æ –∑–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç—å. –ù–∞–º –∏—Å–∫—Ä–µ–Ω–Ω–µ –∂–∞–ª—å, —á—Ç–æ –≤–∏–∑–∏—Ç –ø—Ä–æ—à–µ–ª –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ. üòî  –ù–∞–ø–∏—à–∏—Ç–µ –≤ –æ—Ç–≤–µ—Ç, —á—Ç–æ –Ω–∞–º —Å—Ç–æ–∏—Ç —É–ª—É—á—à–∏—Ç—å? –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–≤–∏–¥–∏—Ç –ª–∏—á–Ω–æ –º–∞—Å—Ç–µ—Ä.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -160,
        736
      ],
      "id": "38b83e9c-57a7-4996-8f65-09fcfd5d82cf",
      "name": "Edit a text message1",
      "webhookId": "80a8e256-fb1a-4a89-96b8-db082ad78a87",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "event_id",
              "keyValue": "={{ $('Code in JavaScript5').item.json.event_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -160,
        544
      ],
      "id": "ac23ae81-b060-4b06-9085-18ea4c63a774",
      "name": "Get Visit Info"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $('Get Visit Info').item.json.master_ref_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        48,
        544
      ],
      "id": "ca2d56fc-ba15-48dc-8edc-c696180e1028",
      "name": "Get Master Link"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "event_id",
              "keyValue": "={{ $('Code in JavaScript5').item.json.event_id }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        48,
        736
      ],
      "id": "c349e78c-475b-4b25-93e0-3eca9722974e",
      "name": "Get Visit Info (Bad)"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "yixtx4eC9r1PFAYb",
          "mode": "list",
          "cachedResultName": "AireminderTest_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/yixtx4eC9r1PFAYb"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "keyValue": "={{ $('Code in JavaScript5').item.json.chat_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "input_mode": "wait_feedback",
            "temp_context": "={{ $('Get Master for Feedback').item.json.master_telegram_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "sent_at",
              "displayName": "sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "last_invite_sent_at",
              "displayName": "last_invite_sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linked_master_id",
              "displayName": "linked_master_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "input_mode",
              "displayName": "input_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "temp_context",
              "displayName": "temp_context",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        464,
        736
      ],
      "id": "dff267ff-3a33-428f-912b-144ccdfb066c",
      "name": "Set Feedback Mode"
    },
    {
      "parameters": {
        "chatId": "={{ $('Get Client Profile').item.json.temp_context }}",
        "text": "=üí¨ <b>–ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –æ—Ç–∑—ã–≤</b> (–û—Ü–µ–Ω–∫–∞: {{ $('Get NPS Score').item.json.last_nps_score }}/5)\n\n<b>–ö–ª–∏–µ–Ω—Ç:</b> {{ $('Get Client Profile').item.json.name }}\n<b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b>\n\"{{ $('Telegram Trigger').item.json.message.text }}\"\n\n<i>Remi —Å–æ—Ö—Ä–∞–Ω–∏–ª –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –≤ —á–∞—Ç–µ, –Ω–æ —Ç–µ–ª–µ—Ñ–æ–Ω —É —Ç–µ–±—è –µ—Å—Ç—å.</i>",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -784,
        928
      ],
      "id": "324c65eb-958a-4969-9d0c-28df7248c205",
      "name": "Send to Master",
      "webhookId": "94300aa5-fabd-436a-a410-afb64973ca3b",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "–°–ø–∞—Å–∏–±–æ –∑–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç—å. –ù–∞–º –∏—Å–∫—Ä–µ–Ω–Ω–µ –∂–∞–ª—å, —á—Ç–æ –≤–∏–∑–∏—Ç –ø—Ä–æ—à–µ–ª –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ. üòî  –í–∞—à –æ—Ç–∑—ã–≤ —É–∂–µ –ø–µ—Ä–µ–¥–∞–Ω –º–∞—Å—Ç–µ—Ä—É –ª–∏—á–Ω–æ. –ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–±–µ—Ä–µ–º —Å–∏—Ç—É–∞—Ü–∏—é, —á—Ç–æ–±—ã –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –≤—Å—ë –±—ã–ª–æ –±–µ–∑—É–ø—Ä–µ—á–Ω–æ. ",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -576,
        928
      ],
      "id": "763489ce-f801-4545-96e4-a45ae1a3f8e9",
      "name": "Thank You",
      "webhookId": "810be0e0-1415-4827-88aa-25b2a1a71f5c",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "yixtx4eC9r1PFAYb",
          "mode": "list",
          "cachedResultName": "AireminderTest_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/yixtx4eC9r1PFAYb"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "temp_context": "={{ null }}",
            "input_mode": "={{ null }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "sent_at",
              "displayName": "sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "last_invite_sent_at",
              "displayName": "last_invite_sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linked_master_id",
              "displayName": "linked_master_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "input_mode",
              "displayName": "input_mode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "temp_context",
              "displayName": "temp_context",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -368,
        928
      ],
      "id": "67ff9b14-4505-4a4d-9dd3-5357043313a3",
      "name": "Clear Mode1"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_telegram_id",
              "keyValue": "={{ ($json.message?.from?.id || $json.callback_query?.from?.id).toString() }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -2128,
        -576
      ],
      "id": "a1dbc215-f17a-4a96-8577-8ccf413cbc16",
      "name": "Get row(s)",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "yixtx4eC9r1PFAYb",
          "mode": "list",
          "cachedResultName": "AireminderTest_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/yixtx4eC9r1PFAYb"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -1920,
        -576
      ],
      "id": "9b792765-6486-4df6-bc63-720992b0359a",
      "name": "Get Client Profile",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.master_ref_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        256,
        736
      ],
      "id": "ac509daf-68dc-47ed-b447-6c635b81b86f",
      "name": "Get Master for Feedback"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/calendar/v3/users/me/calendarList/primary",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.access_token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -928,
        1456
      ],
      "id": "b1e31ad7-44c8-494b-a37b-a82201f16eb5",
      "name": "HTTP Request (Get Settings)"
    },
    {
      "parameters": {
        "jsCode": "const data = $('Telegram Trigger').item.json.callback_query.data; // \"confirm_booking_123\"\nconst eventId = data.replace('confirm_booking_', '');\n\nreturn {\n    json: {\n        event_id: eventId,\n        chat_id: $('Telegram Trigger').item.json.callback_query.message.chat.id,\n        message_id: $('Telegram Trigger').item.json.callback_query.message.message_id\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2624,
        -64
      ],
      "id": "64f0e07a-4a98-4cad-a428-5bb8a7fbbc5c",
      "name": "Code (Parse ID)"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "event_id",
              "keyValue": "={{ $json.event_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "confirmation_status": "confirmed"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "event_id",
              "displayName": "event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "client_name",
              "displayName": "client_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "service_type",
              "displayName": "service_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "appointment_time",
              "displayName": "appointment_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "reminder_sent",
              "displayName": "reminder_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "confirmation_status",
              "displayName": "confirmation_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "client_phone",
              "displayName": "client_phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "reminder_time",
              "displayName": "reminder_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_ref_id",
              "displayName": "master_ref_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "client_email",
              "displayName": "client_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_display_name",
              "displayName": "master_display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_display_name_dat",
              "displayName": "master_display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "google_etag",
              "displayName": "google_etag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "visit_status",
              "displayName": "visit_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "nps_status",
              "displayName": "nps_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -2416,
        -64
      ],
      "id": "96bede9f-79a4-4c33-b9b0-8cf59f67fc89",
      "name": "Update row(s)"
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Code (Parse ID)').item.json.chat_id }}",
        "messageId": "={{ $('Code (Parse ID)').item.json.message_id }}",
        "text": "‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –ñ–¥–µ–º –≤–∞—Å!",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2208,
        -64
      ],
      "id": "8cafdb47-9c59-4c95-bdd4-5a649a641272",
      "name": "Edit a text message2",
      "webhookId": "4632ba49-ff72-47d6-8bcc-4dcc6c049659",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $('Telegram Trigger').item.json.callback_query.data;\nconst eventId = data.replace('cancel_booking_', '');\n\nreturn {\n    json: {\n        event_id: eventId,\n        chat_id: $('Telegram Trigger').item.json.callback_query.message.chat.id,\n        message_id: $('Telegram Trigger').item.json.callback_query.message.message_id\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2640,
        128
      ],
      "id": "0d8a96e1-57da-4546-9f09-068990601707",
      "name": "Code (Parse ID)1"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "event_id",
              "keyValue": "={{ $('Code (Parse ID)1').item.json.event_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "confirmation_status": "cancelled"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "event_id",
              "displayName": "event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "client_name",
              "displayName": "client_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "service_type",
              "displayName": "service_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "appointment_time",
              "displayName": "appointment_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "reminder_sent",
              "displayName": "reminder_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "confirmation_status",
              "displayName": "confirmation_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "client_phone",
              "displayName": "client_phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "reminder_time",
              "displayName": "reminder_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_ref_id",
              "displayName": "master_ref_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "client_email",
              "displayName": "client_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_display_name",
              "displayName": "master_display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_display_name_dat",
              "displayName": "master_display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "google_etag",
              "displayName": "google_etag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "visit_status",
              "displayName": "visit_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "nps_status",
              "displayName": "nps_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -1984,
        128
      ],
      "id": "373704f7-f71f-49f8-8e62-9c648fb00196",
      "name": "Update Status (DB)"
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Code (Parse ID)1').item.json.chat_id }}",
        "messageId": "={{ $('Code (Parse ID)1').item.json.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "üòî –û—á–µ–Ω—å –∂–∞–ª—å. –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞.  –ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–∞—Å—Ç–µ—Ä—É –≤ –ª/—Å –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–æ—à–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ.",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "üìÖ –ù–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –æ–∫–Ω–æ",
                    "additionalFields": {
                      "url": "=https://t.me/pmn8nbot_bot/remi_dev?startapp=client_{{ $('Get Master for Link').item.json.master_telegram_id }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1792,
        128
      ],
      "id": "6dcd7e2a-5bd8-4ed8-a369-d3eaf7466747",
      "name": "Edit a text message3",
      "webhookId": "196932ff-f53e-43b3-8413-a3996c457b82",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "event_id",
              "keyValue": "={{ $('Code (Parse ID)1').item.json.event_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -2432,
        128
      ],
      "id": "3c90e484-6b16-4f7c-95f4-ff6f6c9ae842",
      "name": "Get Visit Info1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Get Master for Alert').item.json.master_telegram_id }}",
        "text": "=üîî <b>–û—Å–≤–æ–±–æ–¥–∏–ª–æ—Å—å –æ–∫–æ—à–∫–æ!</b>\n\n–ö–ª–∏–µ–Ω—Ç {{ $('Get Visit Info1').item.json.client_name }} –æ—Ç–º–µ–Ω–∏–ª –≤–∏–∑–∏—Ç.\nüìÖ {{ DateTime.fromJSDate(new Date($('Get Visit Info1').item.json.appointment_time)).setZone('Europe/Moscow').setLocale('ru').toFormat('d MMMM (EEEE) –≤ HH:mm') }} ({{ $('Get Visit Info1').item.json.service_type }})\n\n<i>–°–æ–≤–µ—Ç: –ü—Ä–µ–¥–ª–æ–∂–∏ —ç—Ç–æ –≤—Ä–µ–º—è –≤ —Å—Ç–æ—Ä–∏—Å Instagram –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</i>",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1392,
        128
      ],
      "id": "d0e4f072-86b7-4143-b193-9f34db654189",
      "name": "Send a text message3",
      "webhookId": "5a391484-a582-4a35-a6d4-03d9c808b18f",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.master_ref_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -1600,
        128
      ],
      "id": "05d32f66-2da6-4701-a5e1-b7cb6e8772dd",
      "name": "Get Master for Alert"
    },
    {
      "parameters": {
        "updates": [
          "callback_query",
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -2368,
        -576
      ],
      "id": "4745fe59-76fc-4240-9e72-2d2408cf0d89",
      "name": "Telegram Trigger",
      "webhookId": "c3fa781f-a19f-46ad-9ab7-d6ddeb345c2f",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyValue": "={{ $json.master_ref_id }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -2224,
        128
      ],
      "id": "222d0453-bbe6-4171-ad48-89e962534482",
      "name": "Get Master for Link"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "272663f2-be6e-441f-bf26-b2667fdfe31b",
              "leftValue": "={{ $('Get Master Link').item.json.yandex_map_link }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        288,
        544
      ],
      "id": "97b8c02e-817b-4897-bd6e-17f4a55747c2",
      "name": "If link empty"
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Code in JavaScript5').item.json.chat_id }}",
        "messageId": "={{ $('Code in JavaScript5').item.json.message_id }}",
        "text": "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤—ã—Å–æ–∫—É—é –æ—Ü–µ–Ω–∫—É! ‚ù§Ô∏è –ú—ã –æ—á–µ–Ω—å —Ä–∞–¥—ã, —á—Ç–æ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        544,
        544
      ],
      "id": "e805eb2d-52b1-4e9a-9256-46a7a49d302c",
      "name": "Edit a text message4",
      "webhookId": "81687f11-ae39-4dae-80f0-60d726f2e9d5",
      "credentials": {
        "telegramApi": {
          "id": "TOjnZmt1uhH2WhUD",
          "name": "Telegram DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "ST8dI3ftnXZnrS5V",
          "mode": "list",
          "cachedResultName": "feedback_history_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/ST8dI3ftnXZnrS5V"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "client_telegram_id",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -1040,
        928
      ],
      "id": "7f7b383c-2df8-464d-9160-ea0ee86d3694",
      "name": "Get NPS Score",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 10
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -1216,
        2304
      ],
      "id": "3d5cc7c5-eb88-4f4b-8ca4-a0801e147981",
      "name": "Schedule Trigger5"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "5aqT1nhgk2TP1Emg",
          "mode": "list",
          "cachedResultName": "masters_oauth_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/5aqT1nhgk2TP1Emg"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "is_active",
              "condition": "isTrue"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -992,
        2304
      ],
      "id": "cf36de05-3397-4af4-a0d6-ecfca80a66e6",
      "name": "Get Active Masters5"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -784,
        2256
      ],
      "id": "9ef85d13-1490-4edc-b18b-fa2c83f2ff5e",
      "name": "Loop Masters5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://oauth2.googleapis.com/token",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "refresh_token",
              "value": "={{ $json.refresh_token }}"
            },
            {
              "name": "grant_type",
              "value": "refresh_token"
            },
            {
              "name": "client_id",
              "value": "={{ $env.GOOGLE_CLIENT_ID }}"
            },
            {
              "name": "client_secret",
              "value": "={{ $env.GOOGLE_CLIENT_SECRET }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -608,
        2256
      ],
      "id": "c82508ad-97d4-47d9-ade0-7a589b28d2cc",
      "name": "Refresh Google Token4"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Analyze the calendar event for a Beauty SaaS notification.\n\nINPUT DATA:\nSummary: {{ $json.summary }}\nDescription: {{ $json.description }}\n\nTASKS:\n1. Extract Client Name, Phone, Service.\n2. **Determine Event Type:**\n   - If it is a personal event (Lunch, Gym, Doctor, Block, Day off, Taxi, Shop, –û–±–µ–¥, –í—Ä–∞—á, –°–ø–æ—Ä—Ç, –ú–∞–≥–∞–∑–∏–Ω) -> Set \"isPersonal\": true.\n   - If it is a work event (Client appointment) -> Set \"isPersonal\": false.\n\nOUTPUT JSON ONLY:\n{\n  \"clientName\": \"string or null\",\n  \"serviceName\": \"string or null\",\n  \"clientPhone\": \"string (11 digits, start with 7) or null\",\n  \"clientEmail\": \"string or null\",\n  \"isPersonal\": boolean\n}"
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1,
      "position": [
        432,
        2256
      ],
      "id": "3ded601d-aed5-4d07-9c6d-1b01aad78022",
      "name": "AI Parser5",
      "credentials": {
        "openAiApi": {
          "id": "KqSsgFJz89NymcBR",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/calendar/v3/calendars/primary/events",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "timeMin",
              "value": "={{ $now.toISO() }}"
            },
            {
              "name": "timeMax",
              "value": "={{ $now.plus({ days: 180 }).toISO() }}"
            },
            {
              "name": "singleEvents",
              "value": "true"
            },
            {
              "name": "orderBy",
              "value": "startTime"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.access_token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -432,
        2256
      ],
      "id": "d6164902-2316-4d4d-958b-866b0a7a24c0",
      "name": "Get Calendar Events4"
    },
    {
      "parameters": {
        "fieldToSplitOut": "items",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -256,
        2256
      ],
      "id": "90a3765b-e3b3-43ac-b77f-700ca9476f8d",
      "name": "Split Events"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "yixtx4eC9r1PFAYb",
          "mode": "list",
          "cachedResultName": "AireminderTest_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/yixtx4eC9r1PFAYb"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $json.client_phone }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "name": "={{ $json.client_name }}",
            "email": "={{ $json.client_email }}",
            "phone": "={{ $json.client_phone }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "sent_at",
              "displayName": "sent_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        1808,
        2256
      ],
      "id": "d024816b-8724-4613-9fd7-43beca13da6e",
      "name": "Upsert AireminderTest4",
      "retryOnFail": true
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "event_id",
              "keyValue": "={{ $json.event_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "client_name": "={{ $json.client_name }}",
            "service_type": "={{ $json.serviceName }}",
            "appointment_time": "={{ $json.appointment_time }}",
            "client_phone": "={{ $json.client_phone }}",
            "master_ref_id": "={{ $json.master_ref_id }}",
            "client_email": "={{ $json.client_email }}",
            "google_etag": "={{ $json.google_etag }}",
            "event_id": "={{ $json.event_id }}",
            "appointment_end_time": "={{ $json.appointment_end_time }}",
            "is_personal": "={{ $json.is_personal }}",
            "missing_phone": "={{ $json.missing_phone }}",
            "google_html_link": "={{ $json.google_html_link }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "event_id",
              "displayName": "event_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "telegram_id",
              "displayName": "telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_telegram_id",
              "displayName": "master_telegram_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "client_name",
              "displayName": "client_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "service_type",
              "displayName": "service_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "appointment_time",
              "displayName": "appointment_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "reminder_sent",
              "displayName": "reminder_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "confirmation_status",
              "displayName": "confirmation_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "client_phone",
              "displayName": "client_phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "reminder_time",
              "displayName": "reminder_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_ref_id",
              "displayName": "master_ref_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "client_email",
              "displayName": "client_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "master_display_name",
              "displayName": "master_display_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "master_display_name_dat",
              "displayName": "master_display_name_dat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "google_etag",
              "displayName": "google_etag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "visit_status",
              "displayName": "visit_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "nps_status",
              "displayName": "nps_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "missing_phone",
              "displayName": "missing_phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "is_personal",
              "displayName": "is_personal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "appointment_end_time",
              "displayName": "appointment_end_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "google_html_link",
              "displayName": "google_html_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        1184,
        2256
      ],
      "id": "ccdfa708-ff4e-4bf8-b831-70150e3f189b",
      "name": "Upsert Appointments4"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "event_id",
              "keyValue": "={{ $json.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -80,
        2320
      ],
      "id": "28defddd-67c5-4f60-9f4f-265135dc5f03",
      "name": "Get Stored Etag",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –í–°–ï –≤—Ö–æ–¥—è—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–º–∞—Å—Å–∏–≤ –∏–∑ 5 —Å–æ–±—ã—Ç–∏–π)\nconst items = $input.all();\n\nreturn items.map(item => {\n    const event = item.json;\n\n    // 1. –ü–æ–ª—É—á–∞–µ–º Etag –∏–∑ Google (–≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å)\n    // –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏, —Ç–∞–∫ –∫–∞–∫ Google –ø—Ä–∏—Å—ã–ª–∞–µ—Ç \"12345\"\n    const newEtag = event.etag ? event.etag.replace(/\"/g, '') : null;\n\n    // 2. –ü–æ–ª—É—á–∞–µ–º Etag –∏–∑ –ë–î\n    // –ï—Å–ª–∏ Merge –Ω–∞—à–µ–ª –∑–∞–ø–∏—Å—å, –ø–æ–ª–µ google_etag –±—É–¥–µ—Ç. –ï—Å–ª–∏ –Ω–µ—Ç - undefined.\n    const oldEtag = event.google_etag || null;\n\n    // 3. –õ–æ–≥–∏–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è\n    let process = false;\n\n    if (!oldEtag) {\n        // –í –ë–î –Ω–µ—Ç Etag (–Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –∏–ª–∏ —Å—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å –±–µ–∑ –≤–µ—Ä—Å–∏–∏) -> –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–ú\n        process = true;\n    } else if (newEtag !== oldEtag) {\n        // Etag –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è -> –ò–ó–ú–ï–ù–ò–õ–ê–°–¨ -> –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–ú\n        process = true;\n    }\n    // –ò–Ω–∞—á–µ (Etag —Å–æ–≤–ø–∞–¥–∞–µ—Ç) -> process = false\n\n    return {\n        json: {\n            process: process,\n            ...event // –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–∞–ª—å—à–µ\n        }\n    };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        96,
        2256
      ],
      "id": "e8be06a4-5bfc-4bfb-9ac2-3f5733491bfa",
      "name": "Check Changes"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "ad160dd6-6d83-498e-8466-d8eb43216394",
              "leftValue": "={{ $json.process }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        272,
        2256
      ],
      "id": "f861c239-4552-44d7-9069-1892af07855b",
      "name": "If"
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "id",
              "field2": "event_id"
            }
          ]
        },
        "joinMode": "enrichInput1",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -80,
        2176
      ],
      "id": "d6c23b45-d792-476e-80f3-1f69678be747",
      "name": "Merge9"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        768,
        2256
      ],
      "id": "793f543c-baa8-4b87-8e09-69a41bed1349",
      "name": "Merge10"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "4f18789e-0296-4e27-a9e2-e52e44953af8",
              "leftValue": "={{ $json.client_phone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.3,
      "position": [
        1392,
        2256
      ],
      "id": "0270867c-e65b-42ee-9dd2-7053e91d091b",
      "name": "Filter4"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—à–ª–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ—à–ª—ã–µ —à–∞–≥–∏\n// –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ \"—è–∫–æ—Ä–Ω–æ–π\" –Ω–æ–¥—ã Merge, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–Ω–æ –±—ã–ª–∏ –ø–æ–ª–Ω—ã–º–∏\nconst items = $('Merge Master and Event Data1').all();\n\n// –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\nconst uniqueClients = {};\n\nitems.forEach(item => {\n    const data = item.json;\n    const phone = data.client_phone;\n\n    // 1. –ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫)\n    if (!phone) return;\n\n    // 2. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ–±—ä–µ–∫—Ç –ø–æ –∫–ª—é—á—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n    // –ï—Å–ª–∏ —Ç–∞–∫–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –±—ã–ª –≤ —ç—Ç–æ–º —Ü–∏–∫–ª–µ, –æ–Ω –ü–ï–†–ï–ó–ê–ü–ò–®–ï–¢–°–Ø –ø–æ—Å–ª–µ–¥–Ω–∏–º.\n    // –≠—Ç–æ –∏ –µ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–µ–π.\n    uniqueClients[phone] = {\n        client_name: data.client_name,\n        client_phone: data.client_phone,\n        client_email: data.client_email\n    };\n});\n\n// –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è N8n\nreturn Object.values(uniqueClients).map(client => ({\n    json: client\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        2256
      ],
      "id": "27a4aee0-bb4a-4179-946d-29de49574c1e",
      "name": "Code in JavaScript12"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "TDjBATMyPrPl9SkA",
          "mode": "list",
          "cachedResultName": "appointment_reminders_DEV",
          "cachedResultUrl": "/projects/gAYQfHCyBbbCUw5c/datatables/TDjBATMyPrPl9SkA"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "master_ref_id",
              "keyValue": "={{ $('Setup Context').item.json.master_id }}"
            },
            {
              "keyName": "appointment_time",
              "condition": "gte",
              "keyValue": "={{ $now.setZone('Europe/Moscow').startOf('day').toISO() }}"
            }
          ]
        },
        "limit": 100
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -160,
        176
      ],
      "id": "9ad0b093-4d15-4269-9790-872886004b2d",
      "name": "Get DB Schedule (Slots)1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞\nfunction toTitleCase(str) {\n    if (!str) return str;\n    return str.toLowerCase().replace(/(^|\\s)\\S/g, (L) => L.toUpperCase());\n}\n\n// 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û)\nlet masterData = {};\ntry {\n    // –ü—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ Loop (–∫–∞–∫ –±—ã–ª–æ)\n    const masterItem = $('Loop Masters5').first();\n    masterData = masterItem ? masterItem.json : {};\n} catch (e) {}\n\n// –ï–°–õ–ò –ù–ï –ù–ê–®–õ–ò (masterData.id –Ω–µ—Ç) - –ë–ï–†–ï–ú –ò–ó –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•\n// –ß–∞—Å—Ç–æ –ø–æ—Å–ª–µ SplitInBatches –¥–∞–Ω–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞ –æ—Å—Ç–∞—é—Ç—Å—è –≤ context –∏–ª–∏ paiedItem\nif (!masterData.id) {\n    try {\n        // –ë–µ—Ä–µ–º ID –∏–∑ –Ω–æ–¥—ã, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –î–û —Ü–∏–∫–ª–∞ (Get Active Masters)\n        // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã –≤ —Ü–∏–∫–ª–µ, –Ω–∞–º –Ω—É–∂–µ–Ω –¢–ï–ö–£–©–ò–ô –º–∞—Å—Ç–µ—Ä.\n        // –°–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –≤ n8n v1 - –≤–∑—è—Ç—å –∏–∑ $json, –µ—Å–ª–∏ –º—ã –ø—Ä–æ–∫–∏–Ω—É–ª–∏ –µ–≥–æ.\n        // –ù–æ –µ—Å–ª–∏ –Ω–µ—Ç - –≤–æ–∑—å–º–µ–º –∂–µ—Å—Ç–∫–æ –∏–∑ Get Active Masters (–ø–µ—Ä–≤–æ–≥–æ), \n        // –ï–°–õ–ò –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ –æ–¥–Ω–æ–º—É –º–∞—Å—Ç–µ—Ä—É –∑–∞ —Ä–∞–∑.\n        \n        const activeMasters = $('Get Active Masters5').all();\n        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –º–∞—Å—Ç–µ—Ä–∞, —á–µ–π —Ç–æ–∫–µ–Ω –º—ã –æ–±–Ω–æ–≤–ª—è–ª–∏\n        // (–≠—Ç–æ –∫–æ—Å—Ç—ã–ª—å, –Ω–æ —Ä–∞–±–æ—á–∏–π, –µ—Å–ª–∏ Loop Masters –Ω–µ –æ—Ç–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç)\n        if (activeMasters.length > 0) {\n             // –í–ê–ñ–ù–û: –≠—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Batch Size —É Loop Masters = 1\n             masterData = activeMasters[0].json; \n        }\n    } catch(e) {}\n}\n\n// --- –í–´–ë–û–† –ò–ú–ï–ù–ò –ú–ê–°–¢–ï–†–ê ---\nlet targetMasterName = \"–º–∞—Å—Ç–µ—Ä—É\"; \nconst hasDative = masterData.display_name_dat && masterData.display_name_dat.toString().trim() !== \"\";\nconst hasDisplay = masterData.display_name && masterData.display_name.toString().trim() !== \"\";\n\nif (hasDative) targetMasterName = masterData.display_name_dat;\nelse if (hasDisplay) targetMasterName = masterData.display_name;\nelse if (masterData.master_name) targetMasterName = masterData.master_name;\n\ntargetMasterName = toTitleCase(targetMasterName);\n\n// 2. –û–±—Ä–∞–±–æ—Ç–∫–∞\nreturn items.map((item) => {\n    try {\n        const data = item.json;\n        // aiContent - –¥–∞–Ω–Ω—ã–µ –æ—Ç –ò–ò (–µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—Å–∫–∞–ª—Å—è)\n        const aiContent = data.message?.content || {};\n        \n        // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• ---\n        // –ï—Å–ª–∏ –ò–ò –Ω–µ –¥–∞–ª –¥–∞–Ω–Ω—ã—Ö (null/undefined), –±–µ—Ä–µ–º –∏—Ö –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏ –ë–î\n        \n        // 1. –¢–µ–ª–µ—Ñ–æ–Ω\n        let rawPhone = aiContent.clientPhone;\n        if (!rawPhone) rawPhone = data.client_phone; // <-- –ë–ï–†–ï–ú –ò–ó –ë–ê–ó–´ –ï–°–õ–ò –ò–ò –ú–û–õ–ß–ò–¢\n\n        // 2. –ò–º—è\n        let rawName = aiContent.clientName;\n        if (!rawName) rawName = data.client_name;    // <-- –ë–ï–†–ï–ú –ò–ó –ë–ê–ó–´\n\n        // 3. Email\n        let rawEmail = aiContent.clientEmail;\n        if (!rawEmail) rawEmail = data.client_email; // <-- –ë–ï–†–ï–ú –ò–ó –ë–ê–ó–´\n        \n        // 4. –£—Å–ª—É–≥–∞\n        let finalServiceType = \"\";\n        if (aiContent.serviceName) {\n            finalServiceType = aiContent.serviceName.toLowerCase();\n        } else if (data.service_type) {\n             finalServiceType = data.service_type;   // <-- –ë–ï–†–ï–ú –ò–ó –ë–ê–ó–´\n        } else {\n            const prefix = targetMasterName.toLowerCase().startsWith(\"–∫ \") ? \"\" : \"–∫ –º–∞—Å—Ç–µ—Ä—É \";\n            finalServiceType = `–∑–∞–ø–∏—Å—å ${prefix}${targetMasterName}`;\n        }\n\n        // –ß–∏—Å—Ç–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, —Ñ–æ—Ä–º–∞—Ç 7XXXXXXXXXX)\n        let cleanPhone = null;\n        if (rawPhone) {\n            let digits = String(rawPhone).replace(/\\D/g, '');\n            if (digits.startsWith('78')) digits = '7' + digits.slice(2);\n            if (digits.startsWith('8')) digits = '7' + digits.slice(1);\n            if (digits.length === 10 && digits.startsWith('9')) digits = '7' + digits;\n            \n            if (digits.length === 11 && digits.startsWith('7')) {\n                cleanPhone = digits;\n            }\n        }\n\n        // ID —Å–æ–±—ã—Ç–∏—è (–±–µ—Ä–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π event_id –∏–ª–∏ google id)\n        let finalId = data.event_id;\n        if (!finalId && data.id && isNaN(data.id)) finalId = data.id;\n        if (!finalId) finalId = data.id;\n\n        return {\n            json: {\n                event_id: String(finalId),\n                master_ref_id: masterData.id,\n                \n                client_name: rawName,\n                client_phone: cleanPhone,\n                client_email: rawEmail,\n                serviceName: finalServiceType,\n              google_html_link: data.htmlLink,\n                \n                appointment_time: data.start?.dateTime || data.start?.date || data.appointment_time,\n              appointment_end_time: data.end?.dateTime || data.end?.date || data.appointment_end_time,\nis_personal: aiContent.isPersonal === true,\nmissing_phone: (aiContent.isPersonal !== true) && !cleanPhone,\n                google_etag: data.etag ? String(data.etag).replace(/\"/g, '') : data.google_etag\n            }\n        };\n    } catch (error) {\n        return { json: { error: error.message } };\n    }\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        2256
      ],
      "id": "403fd584-df3d-4923-84dd-842e40c2c6f6",
      "name": "Merge Master and Event Data1"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook2": {
      "main": [
        [
          {
            "node": "Update row(s)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every Hour Trigger2": {
      "main": [
        [
          {
            "node": "Get Unsent Reminders2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Unsent Reminders2": {
      "main": [
        [
          {
            "node": "Filter 24h Before2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter 24h Before2": {
      "main": [
        [
          {
            "node": "Find Client Telegram2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Client Telegram2": {
      "main": [
        [
          {
            "node": "Remove Duplicates2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message2": {
      "main": [
        [
          {
            "node": "Mark as Sent2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter2": {
      "main": [
        [
          {
            "node": "Send a text message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Filter2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remove Duplicates2": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "HTTP Request (Get Settings)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Upsert row(s)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert row1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert row1": {
      "main": [
        [
          {
            "node": "Set Onboarding State1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Onboarding State1": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Check if Name Needed1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send QR Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code (Extract ID)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Call 'T2'1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Display Name1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Setup Context",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Mode Wait",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send to Master",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get ID Like Blue Button",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code (Parse ID)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code (Parse ID)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert row(s)3": {
      "main": [
        [
          {
            "node": "Send a text message7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Name Needed1": {
      "main": [
        [
          {
            "node": "Ask Name1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get ID Like Blue Button",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ask Name1": {
      "main": [
        [
          {
            "node": "Set Onboarding State2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Display Name1": {
      "main": [
        [
          {
            "node": "AI Inflect Dative1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Inflect Dative1": {
      "main": [
        [
          {
            "node": "Validate Inflection1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Inflection1": {
      "main": [
        [
          {
            "node": "Save Dative Name1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Dative Name1": {
      "main": [
        [
          {
            "node": "Confirm Setup1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirm Setup1": {
      "main": [
        [
          {
            "node": "Get ID Like Blue Button",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Call 'C3 DEV'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert row(s)1": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Get Real Name1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Real Name1": {
      "main": [
        [
          {
            "node": "Upsert row(s)3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook (OPTIONS)": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook (POST)": {
      "main": [
        [
          {
            "node": "Process Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Update Master Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Data": {
      "main": [
        [
          {
            "node": "Save to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook (GET)": {
      "main": [
        [
          {
            "node": "Get Master Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get from DB": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Refresh Token (Slots)": {
      "main": [
        [
          {
            "node": "Get GCal (Slots)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get GCal (Slots)": {
      "main": [
        []
      ]
    },
    "Get DB Schedule (Slots)": {
      "main": [
        [
          {
            "node": "Calculate Free Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Free Slots": {
      "main": [
        [
          {
            "node": "AI Generate Post",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Generate Post": {
      "main": [
        [
          {
            "node": "Send Slots Post",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook (Free Slots)": {
      "main": [
        [
          {
            "node": "Setup Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Context": {
      "main": [
        [
          {
            "node": "Get Master OAuth",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Master OAuth": {
      "main": [
        [
          {
            "node": "Get DB Schedule (Slots)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook (OPTIONS Slots)": {
      "main": [
        [
          {
            "node": "Respond (CORS)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Master Profile": {
      "main": [
        [
          {
            "node": "Get from DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Data": {
      "main": [
        [
          {
            "node": "Return Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code (Extract ID)": {
      "main": [
        [
          {
            "node": "Upsert Link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Link": {
      "main": [
        [
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send QR Code": {
      "main": [
        [
          {
            "node": "Send Link Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Link Text": {
      "main": [
        [
          {
            "node": "Get ID Like Blue Button",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get ID Like Blue Button": {
      "main": [
        [
          {
            "node": "Send Menu HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Mode Wait": {
      "main": [
        [
          {
            "node": "Pls_link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Input Mode": {
      "main": [
        [
          {
            "node": "Is Cancel?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get NPS Score",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Cancel?": {
      "main": [
        [
          {
            "node": "Clear Mode",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validate Yandex URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear Mode": {
      "main": [
        [
          {
            "node": "Get ID Like Blue Button",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Yandex URL": {
      "main": [
        [
          {
            "node": "Save Link DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Link DB": {
      "main": [
        [
          {
            "node": "Msg: Saved",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Msg: Saved": {
      "main": [
        [
          {
            "node": "Get ID Like Blue Button",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook (GET Visits)": {
      "main": [
        [
          {
            "node": "Find Master",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Appointments": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Respond (CORS)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond (CORS)1": {
      "main": [
        []
      ]
    },
    "Code in JavaScript4": {
      "main": [
        [
          {
            "node": "Update Visit Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Visit Status": {
      "main": [
        [
          {
            "node": "Respond to Webhook3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook (POST Visits)": {
      "main": [
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Master": {
      "main": [
        [
          {
            "node": "Get All Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "Upsert row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert row(s)": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Get Visit Info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Visit Info": {
      "main": [
        [
          {
            "node": "Get Master Link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Master Link": {
      "main": [
        [
          {
            "node": "If link empty",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit a text message1": {
      "main": [
        [
          {
            "node": "Get Visit Info (Bad)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Visit Info (Bad)": {
      "main": [
        [
          {
            "node": "Get Master for Feedback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Master": {
      "main": [
        [
          {
            "node": "Thank You",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Thank You": {
      "main": [
        [
          {
            "node": "Clear Mode1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "Get Client Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Client Profile": {
      "main": [
        [
          {
            "node": "Check Input Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Master for Feedback": {
      "main": [
        [
          {
            "node": "Set Feedback Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request (Get Settings)": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code (Parse ID)": {
      "main": [
        [
          {
            "node": "Update row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row(s)": {
      "main": [
        [
          {
            "node": "Edit a text message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code (Parse ID)1": {
      "main": [
        [
          {
            "node": "Get Visit Info1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status (DB)": {
      "main": [
        [
          {
            "node": "Edit a text message3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit a text message3": {
      "main": [
        [
          {
            "node": "Get Master for Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Visit Info1": {
      "main": [
        [
          {
            "node": "Get Master for Link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Master for Alert": {
      "main": [
        [
          {
            "node": "Send a text message3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Master for Link": {
      "main": [
        [
          {
            "node": "Update Status (DB)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If link empty": {
      "main": [
        [
          {
            "node": "Edit a text message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit a text message4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get NPS Score": {
      "main": [
        [
          {
            "node": "Send to Master",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger5": {
      "main": [
        [
          {
            "node": "Get Active Masters5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Masters5": {
      "main": [
        [
          {
            "node": "Loop Masters5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Masters5": {
      "main": [
        [],
        [
          {
            "node": "Refresh Google Token4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Refresh Google Token4": {
      "main": [
        [
          {
            "node": "Get Calendar Events4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Parser5": {
      "main": [
        [
          {
            "node": "Merge10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Calendar Events4": {
      "main": [
        [
          {
            "node": "Split Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Events": {
      "main": [
        [
          {
            "node": "Get Stored Etag",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert AireminderTest4": {
      "main": [
        [
          {
            "node": "Loop Masters5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Appointments4": {
      "main": [
        [
          {
            "node": "Filter4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Stored Etag": {
      "main": [
        [
          {
            "node": "Merge9",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Check Changes": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "AI Parser5",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge10",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge9": {
      "main": [
        [
          {
            "node": "Check Changes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge10": {
      "main": [
        [
          {
            "node": "Merge Master and Event Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter4": {
      "main": [
        [
          {
            "node": "Code in JavaScript12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript12": {
      "main": [
        [
          {
            "node": "Upsert AireminderTest4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get DB Schedule (Slots)1": {
      "main": [
        [
          {
            "node": "Get DB Schedule (Slots)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Master and Event Data1": {
      "main": [
        [
          {
            "node": "Upsert Appointments4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5bcbdb5c-b2eb-4897-9ec2-d857bf47b2b9",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "85425e5dec6ea846726601a38bcc3d16cb358d988743eb7d6a3ac19db9eba71f"
  },
  "id": "U1YGOFq6e7poTt71",
  "tags": []
}