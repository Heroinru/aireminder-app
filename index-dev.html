// 1. НАСТРОЙКИ
const contextNode = $('Setup Context').first();
const context = contextNode ? contextNode.json : {};
const targetDatesStr = context.target_dates || [];
const chatId = context.client_id || context.master_id;

let masterTz = 'Europe/Moscow'; 
let masterDuration = 60;

// Логи
const logs = [];

try {
    const masterProfileNode = $('Get Master OAuth').first();
    if (masterProfileNode) {
        if (masterProfileNode.json.timezone) masterTz = masterProfileNode.json.timezone;
        if (masterProfileNode.json.slot_duration) masterDuration = parseInt(masterProfileNode.json.slot_duration);
    }
} catch(e) {}

logs.push(`Settings: TZ=${masterTz}, Slot=${masterDuration}`);

// 2. ПОЛУЧЕНИЕ ДАННЫХ
let rawSourceA = [];
let rawSourceB = [];

try { rawSourceA = $('Get DB Schedule (Slots)').all().map(i => i.json); } catch (e) {}
try { rawSourceB = $('Get DB Schedule (Slots)1').all().map(i => i.json); } catch (e) {}

logs.push(`Source A count: ${rawSourceA.length}`);
logs.push(`Source B count: ${rawSourceB.length}`);

// Проверяем первый элемент, чтобы понять кто есть кто
if (rawSourceA.length > 0) logs.push(`Source A first keys: ${Object.keys(rawSourceA[0]).join(', ')}`);
if (rawSourceB.length > 0) logs.push(`Source B first keys: ${Object.keys(rawSourceB[0]).join(', ')}`);

let workSchedules = [];
let appointments = [];

function detectSource(data) {
    const validItems = data.filter(item => Object.keys(item).length > 0);
    if (validItems.length === 0) return;

    if (validItems[0].work_date) {
        workSchedules = validItems;
        logs.push("✅ Found Work Schedules in this source");
    } 
    else if (validItems[0].appointment_time) {
        appointments = validItems;
        logs.push("✅ Found Appointments in this source");
    } else {
        logs.push("⚠️ Unknown data structure");
    }
}

detectSource(rawSourceA);
detectSource(rawSourceB);

const freeSlots = [];

// 3. ЦИКЛ
for (const dateStr of targetDatesStr) {
    logs.push(`--- Checking Date: ${dateStr} ---`);
    
    const targetDate = DateTime.fromISO(dateStr, { zone: masterTz });
    
    // Ищем график
    const schedule = workSchedules.find(s => {
        if (!s.work_date) return false;
        return DateTime.fromISO(s.work_date, { zone: masterTz }).hasSame(targetDate, 'day');
    });

    if (!schedule) {
        logs.push(`❌ No schedule found for ${dateStr}. Assuming Day Off.`);
        continue; 
    }

    logs.push(`✅ Schedule found: ${schedule.start_time} - ${schedule.end_time}`);

    const workStart = DateTime.fromFormat(`${dateStr} ${schedule.start_time}`, 'yyyy-MM-dd HH:mm', { zone: masterTz });
    const workEnd = DateTime.fromFormat(`${dateStr} ${schedule.end_time}`, 'yyyy-MM-dd HH:mm', { zone: masterTz });

    // Собираем занятость
    let busyIntervals = [];
    
    appointments.forEach(ev => {
        if (!ev.appointment_time || !ev.appointment_end_time) return;
        const appStart = DateTime.fromISO(ev.appointment_time).setZone(masterTz);
        const appEnd = DateTime.fromISO(ev.appointment_end_time).setZone(masterTz);

        if (appStart.hasSame(targetDate, 'day')) {
            busyIntervals.push({ start: appStart, end: appEnd });
            logs.push(`Busy: ${appStart.toFormat('HH:mm')} - ${appEnd.toFormat('HH:mm')}`);
        }
    });
    
    busyIntervals.sort((a, b) => a.start - b.start);

    // Поиск
    let pointer = workStart;
    const now = DateTime.now().setZone(masterTz);
    
    // Если сегодня
    if (pointer.hasSame(now, 'day') && pointer < now) {
        logs.push(`Today! Adjusting start time to now (${now.toFormat('HH:mm')})`);
        const remainder = 30 - (now.minute % 30);
        pointer = now.plus({ minutes: remainder }).set({ second: 0, millisecond: 0 });
    }

    while (pointer < workEnd) {
        const potentialEnd = pointer.plus({ minutes: masterDuration });
        if (potentialEnd > workEnd) break;

        let collision = null;
        for (const busy of busyIntervals) {
            if (pointer < busy.end && potentialEnd > busy.start) {
                collision = busy;
                break;
            }
        }

        if (collision) {
            pointer = collision.end;
        } else {
            freeSlots.push({
                date: targetDate.toFormat('dd.MM'),
                dayOfWeek: targetDate.setLocale('ru').toFormat('cccc'),
                time: pointer.toFormat('HH:mm')
            });
            pointer = pointer.plus({ minutes: masterDuration });
        }
    }
}

return {
    json: {
        chat_id: chatId,
        role: context.role,
        free_slots: freeSlots,
        slots_count: freeSlots.length,
        source: context.source,
        debug_log: logs // <--- СМОТРИ СЮДА
    }
};
